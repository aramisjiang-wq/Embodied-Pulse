# 新闻功能与置顶系统实现计划

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 为 Embodied Pulse 平台新增新闻功能和通用置顶系统，支持管理端发布每日新闻，用户端在发现模块查看置顶新闻和其他置顶内容。

**Architecture:** 新增 News 表存储每日新闻（富文本），现有内容表增加置顶字段，后端提供新闻 CRUD 和置顶 API，前端新增新闻页面和发现模块置顶区。

**Tech Stack:** Next.js 14 (App Router), Express.js, Prisma, SQLite, Ant Design, TypeScript

---

## Phase 1: 数据库模型更新

### Task 1: 新增 News 表

**Files:**
- Modify: `backend/prisma/schema.prisma`

**Step 1: 在 schema.prisma 中添加 News 模型**

在 `backend/prisma/schema.prisma` 文件末尾添加：

```prisma
model News {
  id          String   @id @default(uuid())
  date        DateTime @db.Date
  title       String
  content     String   @db.Text
  isPinned    Boolean  @default(false)
  pinnedAt    DateTime?
  viewCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
  @@index([isPinned, pinnedAt])
}
```

**Step 2: 运行数据库迁移**

Run: `cd backend && npx prisma migrate dev --name add_news_table`
Expected: Migration successful

**Step 3: 生成 Prisma Client**

Run: `cd backend && npx prisma generate`
Expected: Client generated successfully

**Step 4: Commit**

```bash
git add backend/prisma/schema.prisma backend/prisma/migrations
git commit -m "feat(db): add News table for daily news"
```

---

### Task 2: 现有表增加置顶字段

**Files:**
- Modify: `backend/prisma/schema.prisma`

**Step 1: 为 Paper 模型添加置顶字段**

在 Paper 模型中添加：

```prisma
model Paper {
  // ... 现有字段
  isPinned    Boolean  @default(false)
  pinnedAt    DateTime?
  
  @@index([isPinned, pinnedAt])
}
```

**Step 2: 为 Video 模型添加置顶字段**

在 Video 模型中添加：

```prisma
model Video {
  // ... 现有字段
  isPinned    Boolean  @default(false)
  pinnedAt    DateTime?
  
  @@index([isPinned, pinnedAt])
}
```

**Step 3: 为 GithubRepo 模型添加置顶字段**

在 GithubRepo 模型中添加：

```prisma
model GithubRepo {
  // ... 现有字段
  isPinned    Boolean  @default(false)
  pinnedAt    DateTime?
  
  @@index([isPinned, pinnedAt])
}
```

**Step 4: 为 HuggingFaceModel 模型添加置顶字段**

在 HuggingFaceModel 模型中添加：

```prisma
model HuggingFaceModel {
  // ... 现有字段
  isPinned    Boolean  @default(false)
  pinnedAt    DateTime?
  
  @@index([isPinned, pinnedAt])
}
```

**Step 5: 为 Job 模型添加置顶字段**

在 Job 模型中添加：

```prisma
model Job {
  // ... 现有字段
  isPinned    Boolean  @default(false)
  pinnedAt    DateTime?
  
  @@index([isPinned, pinnedAt])
}
```

**Step 6: 运行数据库迁移**

Run: `cd backend && npx prisma migrate dev --name add_pinned_fields`
Expected: Migration successful

**Step 7: 生成 Prisma Client**

Run: `cd backend && npx prisma generate`
Expected: Client generated successfully

**Step 8: Commit**

```bash
git add backend/prisma/schema.prisma backend/prisma/migrations
git commit -m "feat(db): add isPinned and pinnedAt fields to content tables"
```

---

## Phase 2: 后端 API - 新闻 CRUD

### Task 3: 创建新闻类型定义

**Files:**
- Create: `backend/src/types/news.types.ts`

**Step 1: 创建类型定义文件**

```typescript
export interface News {
  id: string;
  date: Date;
  title: string;
  content: string;
  isPinned: boolean;
  pinnedAt: Date | null;
  viewCount: number;
  createdAt: Date;
  updatedAt: Date;
}

export interface CreateNewsDto {
  date: string;
  title: string;
  content: string;
  isPinned?: boolean;
}

export interface UpdateNewsDto {
  date?: string;
  title?: string;
  content?: string;
  isPinned?: boolean;
}

export interface NewsListQuery {
  page?: number;
  size?: number;
  isPinned?: boolean;
}
```

**Step 2: Commit**

```bash
git add backend/src/types/news.types.ts
git commit -m "feat(types): add News type definitions"
```

---

### Task 4: 创建新闻服务层

**Files:**
- Create: `backend/src/services/news.service.ts`

**Step 1: 创建新闻服务**

```typescript
import { PrismaClient } from '@prisma/client';
import { CreateNewsDto, UpdateNewsDto, NewsListQuery } from '../types/news.types';

const prisma = new PrismaClient();

export const newsService = {
  async findAll(query: NewsListQuery) {
    const { page = 1, size = 20, isPinned } = query;
    const skip = (page - 1) * size;
    
    const where: any = {};
    if (isPinned !== undefined) {
      where.isPinned = isPinned;
    }
    
    const [items, total] = await Promise.all([
      prisma.news.findMany({
        where,
        orderBy: [{ isPinned: 'desc' }, { date: 'desc' }],
        skip,
        take: size,
      }),
      prisma.news.count({ where }),
    ]);
    
    return {
      items,
      total,
      page,
      size,
      totalPages: Math.ceil(total / size),
    };
  },

  async findById(id: string) {
    const news = await prisma.news.findUnique({
      where: { id },
    });
    
    if (news) {
      await prisma.news.update({
        where: { id },
        data: { viewCount: { increment: 1 } },
      });
    }
    
    return news;
  },

  async create(data: CreateNewsDto) {
    return prisma.news.create({
      data: {
        date: new Date(data.date),
        title: data.title,
        content: data.content,
        isPinned: data.isPinned || false,
        pinnedAt: data.isPinned ? new Date() : null,
      },
    });
  },

  async update(id: string, data: UpdateNewsDto) {
    const updateData: any = { ...data };
    
    if (data.date) {
      updateData.date = new Date(data.date);
    }
    
    if (data.isPinned !== undefined) {
      updateData.pinnedAt = data.isPinned ? new Date() : null;
    }
    
    return prisma.news.update({
      where: { id },
      data: updateData,
    });
  },

  async delete(id: string) {
    return prisma.news.delete({
      where: { id },
    });
  },

  async getPinned() {
    return prisma.news.findMany({
      where: { isPinned: true },
      orderBy: { pinnedAt: 'desc' },
    });
  },

  async togglePin(id: string) {
    const news = await prisma.news.findUnique({ where: { id } });
    if (!news) throw new Error('News not found');
    
    return prisma.news.update({
      where: { id },
      data: {
        isPinned: !news.isPinned,
        pinnedAt: !news.isPinned ? new Date() : null,
      },
    });
  },
};
```

**Step 2: Commit**

```bash
git add backend/src/services/news.service.ts
git commit -m "feat(service): add news service with CRUD operations"
```

---

### Task 5: 创建新闻控制器

**Files:**
- Create: `backend/src/controllers/news.controller.ts`

**Step 1: 创建新闻控制器**

```typescript
import { Request, Response } from 'express';
import { newsService } from '../services/news.service';

export async function getNewsList(req: Request, res: Response) {
  try {
    const { page, size, isPinned } = req.query;
    const result = await newsService.findAll({
      page: page ? parseInt(page as string) : 1,
      size: size ? parseInt(size as string) : 20,
      isPinned: isPinned === 'true' ? true : isPinned === 'false' ? false : undefined,
    });
    res.json(result);
  } catch (error) {
    res.status(500).json({ error: 'Failed to fetch news list' });
  }
}

export async function getNewsById(req: Request, res: Response) {
  try {
    const { id } = req.params;
    const news = await newsService.findById(id);
    if (!news) {
      return res.status(404).json({ error: 'News not found' });
    }
    res.json(news);
  } catch (error) {
    res.status(500).json({ error: 'Failed to fetch news' });
  }
}

export async function getPinnedNews(req: Request, res: Response) {
  try {
    const news = await newsService.getPinned();
    res.json(news);
  } catch (error) {
    res.status(500).json({ error: 'Failed to fetch pinned news' });
  }
}

export async function createNews(req: Request, res: Response) {
  try {
    const news = await newsService.create(req.body);
    res.status(201).json(news);
  } catch (error) {
    res.status(500).json({ error: 'Failed to create news' });
  }
}

export async function updateNews(req: Request, res: Response) {
  try {
    const { id } = req.params;
    const news = await newsService.update(id, req.body);
    res.json(news);
  } catch (error) {
    res.status(500).json({ error: 'Failed to update news' });
  }
}

export async function deleteNews(req: Request, res: Response) {
  try {
    const { id } = req.params;
    await newsService.delete(id);
    res.status(204).send();
  } catch (error) {
    res.status(500).json({ error: 'Failed to delete news' });
  }
}

export async function toggleNewsPin(req: Request, res: Response) {
  try {
    const { id } = req.params;
    const news = await newsService.togglePin(id);
    res.json(news);
  } catch (error) {
    res.status(500).json({ error: 'Failed to toggle pin status' });
  }
}
```

**Step 2: Commit**

```bash
git add backend/src/controllers/news.controller.ts
git commit -m "feat(controller): add news controller"
```

---

### Task 6: 创建新闻路由

**Files:**
- Create: `backend/src/routes/news.routes.ts`
- Modify: `backend/src/routes/index.ts`

**Step 1: 创建新闻路由文件**

```typescript
import { Router } from 'express';
import {
  getNewsList,
  getNewsById,
  getPinnedNews,
} from '../controllers/news.controller';

const router = Router();

router.get('/', getNewsList);
router.get('/pinned', getPinnedNews);
router.get('/:id', getNewsById);

export default router;
```

**Step 2: 在路由索引中注册新闻路由**

在 `backend/src/routes/index.ts` 中添加：

```typescript
import newsRoutes from './news.routes';

// 在现有路由注册后添加
router.use('/news', newsRoutes);
```

**Step 3: Commit**

```bash
git add backend/src/routes/news.routes.ts backend/src/routes/index.ts
git commit -m "feat(routes): add news routes for user endpoints"
```

---

### Task 7: 创建管理端新闻路由

**Files:**
- Modify: `backend/src/routes/admin.routes.ts`
- Modify: `backend/src/controllers/admin.controller.ts`

**Step 1: 在 admin.routes.ts 中添加新闻路由**

```typescript
import {
  // ... 现有导入
  createNews,
  updateNews,
  deleteNews,
  toggleNewsPin,
  getAdminNewsList,
} from '../controllers/admin.controller';

// 添加新闻管理路由
router.get('/content/news', getAdminNewsList);
router.post('/content/news', createNews);
router.put('/content/news/:id', updateNews);
router.delete('/content/news/:id', deleteNews);
router.put('/content/news/:id/pin', toggleNewsPin);
```

**Step 2: 在 admin.controller.ts 中添加新闻处理函数**

```typescript
import { newsService } from '../services/news.service';

export async function getAdminNewsList(req: Request, res: Response) {
  try {
    const { page, size } = req.query;
    const result = await newsService.findAll({
      page: page ? parseInt(page as string) : 1,
      size: size ? parseInt(size as string) : 20,
    });
    res.json(result);
  } catch (error) {
    res.status(500).json({ error: 'Failed to fetch news list' });
  }
}

export async function createNews(req: Request, res: Response) {
  try {
    const news = await newsService.create(req.body);
    res.status(201).json(news);
  } catch (error) {
    res.status(500).json({ error: 'Failed to create news' });
  }
}

export async function updateNews(req: Request, res: Response) {
  try {
    const { id } = req.params;
    const news = await newsService.update(id, req.body);
    res.json(news);
  } catch (error) {
    res.status(500).json({ error: 'Failed to update news' });
  }
}

export async function deleteNews(req: Request, res: Response) {
  try {
    const { id } = req.params;
    await newsService.delete(id);
    res.status(204).send();
  } catch (error) {
    res.status(500).json({ error: 'Failed to delete news' });
  }
}

export async function toggleNewsPin(req: Request, res: Response) {
  try {
    const { id } = req.params;
    const news = await newsService.togglePin(id);
    res.json(news);
  } catch (error) {
    res.status(500).json({ error: 'Failed to toggle pin status' });
  }
}
```

**Step 3: Commit**

```bash
git add backend/src/routes/admin.routes.ts backend/src/controllers/admin.controller.ts
git commit -m "feat(admin): add news management routes"
```

---

## Phase 3: 后端 API - 通用置顶功能

### Task 8: 创建通用置顶服务

**Files:**
- Create: `backend/src/services/pin.service.ts`

**Step 1: 创建置顶服务**

```typescript
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

const modelMap: Record<string, any> = {
  papers: prisma.paper,
  videos: prisma.video,
  repos: prisma.githubRepo,
  huggingface: prisma.huggingFaceModel,
  jobs: prisma.job,
  news: prisma.news,
};

export const pinService = {
  async togglePin(type: string, id: string) {
    const model = modelMap[type];
    if (!model) {
      throw new Error(`Unknown content type: ${type}`);
    }

    const item = await model.findUnique({ where: { id } });
    if (!item) {
      throw new Error('Content not found');
    }

    const newPinStatus = !item.isPinned;
    
    return model.update({
      where: { id },
      data: {
        isPinned: newPinStatus,
        pinnedAt: newPinStatus ? new Date() : null,
      },
    });
  },

  async getPinnedItems(type?: string) {
    const types = type ? [type] : Object.keys(modelMap);
    const results: any[] = [];

    for (const t of types) {
      const model = modelMap[t];
      if (model) {
        const items = await model.findMany({
          where: { isPinned: true },
          orderBy: { pinnedAt: 'desc' },
        });
        results.push(...items.map((item: any) => ({ ...item, type: t })));
      }
    }

    return results.sort((a, b) => {
      const aTime = a.pinnedAt?.getTime() || 0;
      const bTime = b.pinnedAt?.getTime() || 0;
      return bTime - aTime;
    });
  },
};
```

**Step 2: Commit**

```bash
git add backend/src/services/pin.service.ts
git commit -m "feat(service): add generic pin service"
```

---

### Task 9: 添加通用置顶 API

**Files:**
- Modify: `backend/src/routes/admin.routes.ts`
- Modify: `backend/src/controllers/admin.controller.ts`

**Step 1: 在 admin.routes.ts 添加通用置顶路由**

```typescript
router.put('/content/:type/:id/pin', toggleContentPin);
```

**Step 2: 在 admin.controller.ts 添加处理函数**

```typescript
import { pinService } from '../services/pin.service';

export async function toggleContentPin(req: Request, res: Response) {
  try {
    const { type, id } = req.params;
    const result = await pinService.togglePin(type, id);
    res.json(result);
  } catch (error) {
    res.status(500).json({ error: 'Failed to toggle pin status' });
  }
}
```

**Step 3: Commit**

```bash
git add backend/src/routes/admin.routes.ts backend/src/controllers/admin.controller.ts
git commit -m "feat(admin): add generic pin toggle API"
```

---

### Task 10: 修改发现模块 API 支持置顶内容

**Files:**
- Modify: `backend/src/services/discovery.service.ts`
- Modify: `backend/src/controllers/discovery.controller.ts`

**Step 1: 在 discovery.service.ts 添加获取置顶内容的方法**

```typescript
import { pinService } from './pin.service';

export async function getDiscoveryWithPinned(contentType?: string, sortType?: string, page?: number, size?: number) {
  const [pinnedItems, regularItems] = await Promise.all([
    contentType === 'all' || contentType === 'news' 
      ? pinService.getPinnedItems(contentType === 'news' ? 'news' : undefined)
      : pinService.getPinnedItems(contentType),
    getDiscovery(contentType, sortType, page, size),
  ]);

  return {
    pinnedItems,
    ...regularItems,
  };
}
```

**Step 2: 在 discovery.controller.ts 修改返回结构**

```typescript
export async function getDiscovery(req: Request, res: Response) {
  try {
    const { contentType, sortType, page, size } = req.query;
    const result = await discoveryService.getDiscoveryWithPinned(
      contentType as string,
      sortType as string,
      page ? parseInt(page as string) : 1,
      size ? parseInt(size as string) : 20
    );
    res.json(result);
  } catch (error) {
    res.status(500).json({ error: 'Failed to fetch discovery content' });
  }
}
```

**Step 3: Commit**

```bash
git add backend/src/services/discovery.service.ts backend/src/controllers/discovery.controller.ts
git commit -m "feat(discovery): add pinned items to discovery API"
```

---

## Phase 4: 前端类型定义和 API 客户端

### Task 11: 添加前端新闻类型定义

**Files:**
- Modify: `frontend/src/lib/api/types.ts`

**Step 1: 在 types.ts 中添加新闻类型**

```typescript
export interface News {
  id: string;
  date: string;
  title: string;
  content: string;
  isPinned: boolean;
  pinnedAt: string | null;
  viewCount: number;
  createdAt: string;
  updatedAt: string;
}

export interface NewsListResponse {
  items: News[];
  total: number;
  page: number;
  size: number;
  totalPages: number;
}

export interface CreateNewsRequest {
  date: string;
  title: string;
  content: string;
  isPinned?: boolean;
}

export interface UpdateNewsRequest {
  date?: string;
  title?: string;
  content?: string;
  isPinned?: boolean;
}
```

**Step 2: 更新 FeedItem 类型**

```typescript
export interface FeedItem {
  id: string;
  type: 'paper' | 'video' | 'github' | 'huggingface' | 'job' | 'community' | 'news';
  title: string;
  description?: string;
  // ... 其他字段
  isPinned?: boolean;
  pinnedAt?: string | null;
}
```

**Step 3: Commit**

```bash
git add frontend/src/lib/api/types.ts
git commit -m "feat(types): add News and FeedItem types"
```

---

### Task 12: 创建新闻 API 客户端

**Files:**
- Create: `frontend/src/lib/api/news.ts`

**Step 1: 创建新闻 API 客户端**

```typescript
import { cachedClient } from './cached-client';
import { News, NewsListResponse, CreateNewsRequest, UpdateNewsRequest } from './types';

export const newsApi = {
  async getNewsList(params?: { page?: number; size?: number; isPinned?: boolean }): Promise<NewsListResponse> {
    const query = new URLSearchParams();
    if (params?.page) query.set('page', params.page.toString());
    if (params?.size) query.set('size', params.size.toString());
    if (params?.isPinned !== undefined) query.set('isPinned', params.isPinned.toString());
    
    return cachedClient.get(`/news?${query.toString()}`);
  },

  async getNewsById(id: string): Promise<News> {
    return cachedClient.get(`/news/${id}`);
  },

  async getPinnedNews(): Promise<News[]> {
    return cachedClient.get('/news/pinned');
  },

  async createNews(data: CreateNewsRequest): Promise<News> {
    return cachedClient.post('/admin/content/news', data);
  },

  async updateNews(id: string, data: UpdateNewsRequest): Promise<News> {
    return cachedClient.put(`/admin/content/news/${id}`, data);
  },

  async deleteNews(id: string): Promise<void> {
    return cachedClient.delete(`/admin/content/news/${id}`);
  },

  async togglePin(id: string): Promise<News> {
    return cachedClient.put(`/admin/content/news/${id}/pin`, {});
  },

  async toggleContentPin(type: string, id: string): Promise<any> {
    return cachedClient.put(`/admin/content/${type}/${id}/pin`, {});
  },
};
```

**Step 2: Commit**

```bash
git add frontend/src/lib/api/news.ts
git commit -m "feat(api): add news API client"
```

---

### Task 13: 更新发现模块 API 客户端

**Files:**
- Modify: `frontend/src/lib/api/discovery.ts`

**Step 1: 更新返回类型**

```typescript
export interface DiscoveryResponse {
  pinnedItems: FeedItem[];
  items: FeedItem[];
  total: number;
  page: number;
  size: number;
}

export const discoveryApi = {
  async getDiscovery(params: {
    contentType?: 'all' | 'github' | 'huggingface' | 'video' | 'paper' | 'community' | 'news';
    sortType?: 'hot' | 'latest';
    page?: number;
    size?: number;
  }): Promise<DiscoveryResponse> {
    // ... 现有实现
  },
};
```

**Step 2: Commit**

```bash
git add frontend/src/lib/api/discovery.ts
git commit -m "feat(api): update discovery API to include pinned items"
```

---

## Phase 5: 前端 - 用户端新闻页面

### Task 14: 创建新闻列表页

**Files:**
- Create: `frontend/src/app/news/page.tsx`

**Step 1: 创建新闻列表页面**

```tsx
'use client';

import { useState, useEffect } from 'react';
import { Card, List, Typography, Tag, Pagination, Spin, Empty } from 'antd';
import { CalendarOutlined } from '@ant-design/icons';
import Link from 'next/link';
import { newsApi } from '@/lib/api/news';
import { News } from '@/lib/api/types';

const { Title, Text, Paragraph } = Typography;

export default function NewsListPage() {
  const [news, setNews] = useState<News[]>([]);
  const [loading, setLoading] = useState(true);
  const [page, setPage] = useState(1);
  const [total, setTotal] = useState(0);
  const pageSize = 20;

  useEffect(() => {
    fetchNews();
  }, [page]);

  const fetchNews = async () => {
    setLoading(true);
    try {
      const result = await newsApi.getNewsList({ page, size: pageSize });
      setNews(result.items);
      setTotal(result.total);
    } catch (error) {
      console.error('Failed to fetch news:', error);
    } finally {
      setLoading(false);
    }
  };

  const formatDate = (dateStr: string) => {
    const date = new Date(dateStr);
    return `${date.getMonth() + 1}月${date.getDate()}日`;
  };

  const getSummary = (content: string) => {
    const lines = content.split('\n').filter((line) => line.trim());
    return lines.slice(0, 3).join(' ').substring(0, 150) + '...';
  };

  return (
    <div className="max-w-4xl mx-auto p-6">
      <Title level={2}>每日新闻</Title>
      <Text type="secondary">具身智能领域最新动态</Text>

      <Spin spinning={loading}>
        {news.length === 0 ? (
          <Empty description="暂无新闻" className="mt-8" />
        ) : (
          <List
            className="mt-6"
            itemLayout="vertical"
            dataSource={news}
            renderItem={(item) => (
              <List.Item key={item.id}>
                <Card
                  hoverable
                  className="w-full"
                  styles={{ body: { padding: '16px 24px' } }}
                >
                  <Link href={`/news/${item.id}`}>
                    <div className="flex items-center gap-2 mb-2">
                      <CalendarOutlined style={{ color: '#1890ff' }} />
                      <Text type="secondary">{formatDate(item.date)}</Text>
                      {item.isPinned && (
                        <Tag color="blue">置顶</Tag>
                      )}
                    </div>
                    <Title level={4} className="mb-2">
                      {item.title}
                    </Title>
                    <Paragraph ellipsis={{ rows: 2 }} type="secondary">
                      {getSummary(item.content)}
                    </Paragraph>
                    <div className="flex items-center gap-4 text-gray-400 text-sm">
                      <span>浏览 {item.viewCount}</span>
                    </div>
                  </Link>
                </Card>
              </List.Item>
            )}
          />
        )}

        {total > pageSize && (
          <div className="flex justify-center mt-6">
            <Pagination
              current={page}
              pageSize={pageSize}
              total={total}
              onChange={setPage}
              showSizeChanger={false}
            />
          </div>
        )}
      </Spin>
    </div>
  );
}
```

**Step 2: Commit**

```bash
git add frontend/src/app/news/page.tsx
git commit -m "feat(news): add news list page"
```

---

### Task 15: 创建新闻详情页

**Files:**
- Create: `frontend/src/app/news/[id]/page.tsx`

**Step 1: 创建新闻详情页面**

```tsx
'use client';

import { useState, useEffect } from 'react';
import { Card, Typography, Tag, Spin, Button, message } from 'antd';
import { ArrowLeftOutlined, ShareOutlined, CalendarOutlined } from '@ant-design/icons';
import Link from 'next/link';
import { useParams, useRouter } from 'next/navigation';
import { newsApi } from '@/lib/api/news';
import { News } from '@/lib/api/types';

const { Title, Text, Paragraph } = Typography;

export default function NewsDetailPage() {
  const params = useParams();
  const router = useRouter();
  const [news, setNews] = useState<News | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (params.id) {
      fetchNews(params.id as string);
    }
  }, [params.id]);

  const fetchNews = async (id: string) => {
    setLoading(true);
    try {
      const result = await newsApi.getNewsById(id);
      setNews(result);
    } catch (error) {
      console.error('Failed to fetch news:', error);
      message.error('获取新闻失败');
    } finally {
      setLoading(false);
    }
  };

  const formatDate = (dateStr: string) => {
    const date = new Date(dateStr);
    return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
  };

  const handleShare = () => {
    if (navigator.share) {
      navigator.share({
        title: news?.title,
        url: window.location.href,
      });
    } else {
      navigator.clipboard.writeText(window.location.href);
      message.success('链接已复制');
    }
  };

  const renderMarkdown = (content: string) => {
    return content.split('\n').map((line, index) => {
      if (line.startsWith('## ')) {
        return (
          <Title key={index} level={4} className="mt-6 mb-3">
            {line.replace('## ', '')}
          </Title>
        );
      }
      if (line.startsWith('### ')) {
        return (
          <Title key={index} level={5} className="mt-4 mb-2">
            {line.replace('### ', '')}
          </Title>
        );
      }
      if (line.startsWith('**') && line.endsWith('**')) {
        return (
          <Paragraph key={index} strong>
            {line.replace(/\*\*/g, '')}
          </Paragraph>
        );
      }
      if (line.trim().startsWith('- ')) {
        return (
          <Paragraph key={index} className="ml-4">
            • {line.trim().substring(2)}
          </Paragraph>
        );
      }
      if (line.match(/^\d+\./)) {
        return (
          <Paragraph key={index} className="ml-4">
            {line}
          </Paragraph>
        );
      }
      if (line.trim()) {
        return <Paragraph key={index}>{line}</Paragraph>;
      }
      return null;
    });
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-[400px]">
        <Spin size="large" />
      </div>
    );
  }

  if (!news) {
    return (
      <div className="max-w-4xl mx-auto p-6 text-center">
        <Title level={4}>新闻不存在</Title>
        <Link href="/news">
          <Button type="primary">返回列表</Button>
        </Link>
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto p-6">
      <Button
        type="text"
        icon={<ArrowLeftOutlined />}
        onClick={() => router.back()}
        className="mb-4"
      >
        返回
      </Button>

      <Card>
        <div className="flex items-center gap-2 mb-4">
          <CalendarOutlined style={{ color: '#1890ff' }} />
          <Text type="secondary">{formatDate(news.date)}</Text>
          {news.isPinned && <Tag color="blue">置顶</Tag>}
        </div>

        <Title level={2} className="mb-4">
          {news.title}
        </Title>

        <div className="flex items-center gap-4 text-gray-400 text-sm mb-6">
          <span>浏览 {news.viewCount}</span>
        </div>

        <div className="news-content">{renderMarkdown(news.content)}</div>

        <div className="flex justify-end mt-6 pt-4 border-t">
          <Button icon={<ShareOutlined />} onClick={handleShare}>
            分享
          </Button>
        </div>
      </Card>
    </div>
  );
}
```

**Step 2: Commit**

```bash
git add frontend/src/app/news/[id]/page.tsx
git commit -m "feat(news): add news detail page"
```

---

## Phase 6: 前端 - 发现模块修改

### Task 16: 创建置顶内容组件

**Files:**
- Create: `frontend/src/components/PinnedItems.tsx`

**Step 1: 创建置顶内容组件**

```tsx
'use client';

import { useState } from 'react';
import { Card, Collapse, Tag, Typography, Button, Spin } from 'antd';
import { 
  PushpinOutlined, 
  FileTextOutlined, 
  VideoOutlined, 
  GithubOutlined,
  ExperimentOutlined,
  TeamOutlined,
  ExpandOutlined,
  CompressOutlined,
} from '@ant-design/icons';
import Link from 'next/link';
import { FeedItem } from '@/lib/api/types';

const { Text, Paragraph } = Typography;

interface PinnedItemsProps {
  items: FeedItem[];
  loading?: boolean;
}

const typeIcons: Record<string, any> = {
  news: FileTextOutlined,
  paper: FileTextOutlined,
  video: VideoOutlined,
  github: GithubOutlined,
  huggingface: ExperimentOutlined,
  job: TeamOutlined,
};

const typeLabels: Record<string, string> = {
  news: '新闻',
  paper: '论文',
  video: '视频',
  github: 'GitHub',
  huggingface: 'HuggingFace',
  job: '招聘',
};

const typeRoutes: Record<string, string> = {
  news: '/news',
  paper: '/papers',
  video: '/videos',
  github: '/repos',
  huggingface: '/huggingface',
  job: '/jobs',
};

export default function PinnedItems({ items, loading }: PinnedItemsProps) {
  const [expanded, setExpanded] = useState(false);

  if (loading) {
    return (
      <Card className="mb-4">
        <div className="flex justify-center py-4">
          <Spin />
        </div>
      </Card>
    );
  }

  if (!items || items.length === 0) {
    return null;
  }

  const displayItems = expanded ? items : items.slice(0, 3);
  const hasMore = items.length > 3;

  const renderNewsItem = (item: FeedItem) => (
    <div key={item.id} className="pinned-news-item">
      <div className="flex items-center justify-between">
        <Link href={`/news/${item.id}`} className="flex-1">
          <div className="flex items-center gap-2">
            <FileTextOutlined style={{ color: '#1890ff' }} />
            <Text strong className="text-base hover:text-blue-500 cursor-pointer">
              {item.title}
            </Text>
          </div>
          {item.description && (
            <Paragraph 
              ellipsis={{ rows: 1 }} 
              type="secondary" 
              className="mt-1 ml-6"
            >
              {item.description}
            </Paragraph>
          )}
        </Link>
        <Link href={`/news/${item.id}`}>
          <Button type="link" size="small">
            查看
          </Button>
        </Link>
      </div>
    </div>
  );

  const renderOtherItem = (item: FeedItem) => {
    const Icon = typeIcons[item.type] || FileTextOutlined;
    const route = typeRoutes[item.type];
    
    return (
      <div key={item.id} className="flex items-center justify-between py-2">
        <Link href={`${route}/${item.id}`} className="flex-1">
          <div className="flex items-center gap-2">
            <Icon style={{ color: '#1890ff' }} />
            <Text className="hover:text-blue-500 cursor-pointer">
              {item.title}
            </Text>
          </div>
        </Link>
        <Link href={`${route}/${item.id}`}>
          <Button type="link" size="small">
            查看
          </Button>
        </Link>
      </div>
    );
  };

  return (
    <Card 
      className="mb-4"
      title={
        <div className="flex items-center gap-2">
          <PushpinOutlined style={{ color: '#1890ff' }} />
          <span>置顶内容</span>
          <Tag color="blue">{items.length}</Tag>
        </div>
      }
      extra={
        hasMore && (
          <Button 
            type="text" 
            icon={expanded ? <CompressOutlined /> : <ExpandOutlined />}
            onClick={() => setExpanded(!expanded)}
          >
            {expanded ? '收起' : `展开全部 (${items.length})`}
          </Button>
        )
      }
    >
      <div className="space-y-3">
        {displayItems.map((item) => (
          item.type === 'news' ? renderNewsItem(item) : renderOtherItem(item)
        ))}
      </div>
    </Card>
  );
}
```

**Step 2: Commit**

```bash
git add frontend/src/components/PinnedItems.tsx
git commit -m "feat(component): add PinnedItems component"
```

---

### Task 17: 修改发现模块组件

**Files:**
- Modify: `frontend/src/components/DiscoveryModule.tsx`

**Step 1: 在 DiscoveryModule 中添加新闻标签和置顶区**

修改标签列表，添加"新闻"标签：

```tsx
const contentTypes = [
  { key: 'all', label: '全部' },
  { key: 'paper', label: '论文' },
  { key: 'github', label: 'GitHub' },
  { key: 'huggingface', label: 'HuggingFace' },
  { key: 'video', label: '视频' },
  { key: 'community', label: '市集' },
  { key: 'news', label: '新闻' },
];
```

**Step 2: 在组件中添加置顶区渲染**

```tsx
import PinnedItems from './PinnedItems';

// 在组件中
const [pinnedItems, setPinnedItems] = useState<FeedItem[]>([]);

// 在 fetchDiscovery 中更新
const fetchDiscovery = async () => {
  setLoading(true);
  try {
    const result = await discoveryApi.getDiscovery({
      contentType,
      sortType,
      page,
      size: pageSize,
    });
    setPinnedItems(result.pinnedItems || []);
    setItems(result.items);
    setTotal(result.total);
  } catch (error) {
    console.error('Failed to fetch discovery:', error);
  } finally {
    setLoading(false);
  }
};

// 在渲染中添加置顶区
{contentType === 'all' && (
  <PinnedItems items={pinnedItems} loading={loading} />
)}
```

**Step 3: Commit**

```bash
git add frontend/src/components/DiscoveryModule.tsx
git commit -m "feat(discovery): add news tab and pinned section"
```

---

## Phase 7: 前端 - 管理端新闻管理

### Task 18: 创建管理端新闻管理组件

**Files:**
- Modify: `frontend/src/app/admin/content/page.tsx`

**Step 1: 在管理端内容页面添加新闻 Tab**

```tsx
import { newsApi } from '@/lib/api/news';

// 在 tabs 配置中添加
const tabs = [
  { key: 'banners', label: 'Banner' },
  { key: 'papers', label: '论文' },
  { key: 'videos', label: '视频' },
  { key: 'repos', label: 'GitHub项目' },
  { key: 'huggingface', label: 'HuggingFace' },
  { key: 'jobs', label: '招聘岗位' },
  { key: 'news', label: '新闻' },
];
```

**Step 2: 添加新闻列表渲染逻辑**

```tsx
const renderNewsList = () => (
  <div>
    <div className="mb-4 flex justify-end">
      <Button type="primary" onClick={() => setShowNewsModal(true)}>
        新建新闻
      </Button>
    </div>
    <Table
      columns={[
        { title: '日期', dataIndex: 'date', key: 'date', render: (date: string) => formatDate(date) },
        { title: '标题', dataIndex: 'title', key: 'title' },
        { 
          title: '置顶', 
          dataIndex: 'isPinned', 
          key: 'isPinned',
          render: (isPinned: boolean, record: News) => (
            <Switch 
              checked={isPinned} 
              onChange={() => handleToggleNewsPin(record.id)}
            />
          )
        },
        { title: '浏览量', dataIndex: 'viewCount', key: 'viewCount' },
        {
          title: '操作',
          key: 'actions',
          render: (_: any, record: News) => (
            <Space>
              <Button type="link" onClick={() => handleEditNews(record)}>编辑</Button>
              <Button type="link" danger onClick={() => handleDeleteNews(record.id)}>删除</Button>
            </Space>
          ),
        },
      ]}
      dataSource={newsList}
      rowKey="id"
      pagination={{
        current: newsPage,
        pageSize: 10,
        total: newsTotal,
        onChange: setNewsPage,
      }}
    />
  </div>
);
```

**Step 3: Commit**

```bash
git add frontend/src/app/admin/content/page.tsx
git commit -m "feat(admin): add news management tab"
```

---

### Task 19: 创建新闻编辑弹窗

**Files:**
- Modify: `frontend/src/app/admin/content/page.tsx`

**Step 1: 添加新闻编辑 Modal**

```tsx
const [showNewsModal, setShowNewsModal] = useState(false);
const [editingNews, setEditingNews] = useState<News | null>(null);
const [newsForm] = Form.useForm();

const handleCreateNews = async (values: any) => {
  try {
    await newsApi.createNews(values);
    message.success('创建成功');
    setShowNewsModal(false);
    newsForm.resetFields();
    fetchNewsList();
  } catch (error) {
    message.error('创建失败');
  }
};

const handleUpdateNews = async (values: any) => {
  if (!editingNews) return;
  try {
    await newsApi.updateNews(editingNews.id, values);
    message.success('更新成功');
    setShowNewsModal(false);
    setEditingNews(null);
    newsForm.resetFields();
    fetchNewsList();
  } catch (error) {
    message.error('更新失败');
  }
};

const handleToggleNewsPin = async (id: string) => {
  try {
    await newsApi.togglePin(id);
    message.success('操作成功');
    fetchNewsList();
  } catch (error) {
    message.error('操作失败');
  }
};

// Modal 组件
<Modal
  title={editingNews ? '编辑新闻' : '新建新闻'}
  open={showNewsModal}
  onCancel={() => {
    setShowNewsModal(false);
    setEditingNews(null);
    newsForm.resetFields();
  }}
  footer={null}
  width={800}
>
  <Form
    form={newsForm}
    layout="vertical"
    onFinish={editingNews ? handleUpdateNews : handleCreateNews}
    initialValues={editingNews || { date: dayjs().format('YYYY-MM-DD') }}
  >
    <Form.Item name="date" label="日期" rules={[{ required: true }]}>
      <Input type="date" />
    </Form.Item>
    <Form.Item name="title" label="标题" rules={[{ required: true }]}>
      <Input placeholder="如：（2月23日）具身智能领域动态" />
    </Form.Item>
    <Form.Item name="content" label="内容" rules={[{ required: true }]}>
      <Input.TextArea rows={15} placeholder="支持 Markdown 格式" />
    </Form.Item>
    <Form.Item name="isPinned" valuePropName="checked">
      <Checkbox>置顶显示</Checkbox>
    </Form.Item>
    <Form.Item>
      <Space>
        <Button type="primary" htmlType="submit">
          {editingNews ? '更新' : '创建'}
        </Button>
        <Button onClick={() => setShowNewsModal(false)}>取消</Button>
      </Space>
    </Form.Item>
  </Form>
</Modal>
```

**Step 2: Commit**

```bash
git add frontend/src/app/admin/content/page.tsx
git commit -m "feat(admin): add news edit modal"
```

---

### Task 20: 添加通用置顶操作

**Files:**
- Modify: `frontend/src/app/admin/content/page.tsx`

**Step 1: 在各内容列表的操作列添加置顶按钮**

```tsx
const handleTogglePin = async (type: string, id: string) => {
  try {
    await newsApi.toggleContentPin(type, id);
    message.success('操作成功');
    // 刷新对应列表
    fetchListByType(type);
  } catch (error) {
    message.error('操作失败');
  }
};

// 在表格列中添加置顶开关
{
  title: '置顶',
  key: 'pinned',
  render: (_: any, record: any) => (
    <Switch
      checked={record.isPinned}
      onChange={() => handleTogglePin(activeTab, record.id)}
    />
  ),
}
```

**Step 2: Commit**

```bash
git add frontend/src/app/admin/content/page.tsx
git commit -m "feat(admin): add pin toggle for all content types"
```

---

## Phase 8: 验证和测试

### Task 21: 验证后端 API

**Step 1: 测试新闻 API**

Run: `curl http://localhost:3001/api/news`
Expected: 返回空列表或新闻数据

**Step 2: 测试创建新闻**

Run: 
```bash
curl -X POST http://localhost:3001/api/admin/content/news \
  -H "Content-Type: application/json" \
  -d '{"date":"2026-02-24","title":"测试新闻","content":"测试内容"}'
```
Expected: 返回创建的新闻对象

**Step 3: 测试置顶 API**

Run:
```bash
curl -X PUT http://localhost:3001/api/admin/content/news/{news_id}/pin
```
Expected: 返回更新后的新闻对象，isPinned 为 true

---

### Task 22: 验证前端页面

**Step 1: 访问新闻列表页**

Open: `http://localhost:3000/news`
Expected: 显示新闻列表页面

**Step 2: 访问新闻详情页**

Open: `http://localhost:3000/news/{news_id}`
Expected: 显示新闻详情

**Step 3: 访问管理端新闻管理**

Open: `http://localhost:3000/admin/content`
Click: 新闻 Tab
Expected: 显示新闻管理界面

**Step 4: 验证发现模块置顶区**

Open: `http://localhost:3000/`
Expected: 发现模块显示置顶内容

---

### Task 23: 最终提交

**Step 1: 确认所有功能正常**

- [ ] 新闻列表页正常显示
- [ ] 新闻详情页正常显示
- [ ] 管理端可以创建/编辑/删除新闻
- [ ] 管理端可以置顶/取消置顶
- [ ] 发现模块显示置顶内容
- [ ] 发现模块新闻标签正常工作

**Step 2: 最终 Commit**

```bash
git add .
git commit -m "feat: complete news and pin system implementation"
```

---

## 执行选项

**计划已保存到 `docs/02-设计/新闻功能与置顶系统设计.md`**

**两种执行方式：**

**1. Subagent-Driven (当前会话)** - 我在当前会话中逐个任务执行，每个任务完成后进行代码审查，快速迭代

**2. Parallel Session (新会话)** - 打开新会话使用 executing-plans，批量执行并设置检查点

**你选择哪种方式？**

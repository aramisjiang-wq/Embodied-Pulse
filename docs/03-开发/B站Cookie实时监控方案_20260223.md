# B站Cookie实时监控方案

**文档版本**: v1.0
**创建日期**: 2026-02-23
**最后更新**: 2026-02-23
**适用范围**: B站Cookie管理、实时监控

---

## 一、需求背景

用户希望实时监控Cookie的有效状态，方便在管理端直接更换Cookie，确保上线后系统稳定运行。

### 1.1 现有问题

| 问题 | 描述 |
|------|------|
| Cookie存储在内存中 | 服务重启后Cookie丢失 |
| 设置无法持久化 | 自动轮换、健康检查间隔等设置无法保存 |
| 无法实时查看状态 | 管理界面无法看到Cookie的实时健康状态 |

---

## 二、解决方案

### 2.1 架构设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Cookie实时监控架构                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [管理端]                         [后端]                                 │
│                                                                         │
│  ┌─────────────────────┐         ┌─────────────────────────────────┐   │
│  │ Cookie管理页面       │         │ BilibiliCookieManager           │   │
│  │ - 状态展示          │◄───────►│ - 内存缓存 + 数据库持久化        │   │
│  │ - 添加/删除         │         │ - 自动同步                       │   │
│  │ - 健康检查          │         │ - 错误计数                       │   │
│  │ - 设置配置          │         └─────────────────────────────────┘   │
│  └─────────────────────┘                      │                        │
│                                               ▼                        │
│                                    ┌─────────────────────────────────┐  │
│                                    │ SQLite数据库                    │  │
│                                    │ - bilibili_cookies表            │  │
│                                    │ - bilibili_cookie_settings表    │  │
│                                    └─────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 数据库模型

#### bilibili_cookies 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 主键 |
| name | String | Cookie名称 |
| cookie | String | Cookie内容 |
| priority | Int | 优先级 |
| is_active | Boolean | 是否激活 |
| error_count | Int | 错误次数 |
| last_error | String? | 最后错误信息 |
| last_used_at | DateTime? | 最后使用时间 |
| last_check_at | DateTime? | 最后检查时间 |
| check_result | String? | 检查结果 |
| user_mid | String? | 关联用户mid |
| user_name | String? | 关联用户名 |
| source | String | 来源(manual/env) |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

#### bilibili_cookie_settings 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 主键 |
| auto_rotate_enabled | Boolean | 自动轮换开关 |
| health_check_interval | Int | 健康检查间隔(秒) |
| max_error_count | Int | 最大错误次数 |
| alert_enabled | Boolean | 告警开关 |
| updated_at | DateTime | 更新时间 |

---

## 三、API接口

### 3.1 Cookie管理接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/bilibili-cookies/status | 获取Cookie状态 |
| GET | /api/admin/bilibili-cookies/health | 获取健康摘要 |
| GET | /api/admin/bilibili-cookies/check | 检查所有Cookie |
| GET | /api/admin/bilibili-cookies/:id/check | 检查单个Cookie |
| POST | /api/admin/bilibili-cookies | 添加Cookie |
| DELETE | /api/admin/bilibili-cookies/:id | 删除Cookie |
| PUT | /api/admin/bilibili-cookies/:id/toggle | 切换状态 |
| PUT | /api/admin/bilibili-cookies/:id/reset | 重置错误计数 |
| POST | /api/admin/bilibili-cookies/rotate | 手动轮换 |

### 3.2 设置接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/bilibili-cookies/settings | 获取设置 |
| PUT | /api/admin/bilibili-cookies/settings | 更新设置 |

---

## 四、使用说明

### 4.1 获取Cookie

1. 打开浏览器，登录 [bilibili.com](https://www.bilibili.com)
2. 按 `F12` 打开开发者工具
3. 切换到 **Network** 标签页
4. 刷新页面，点击任意请求
5. 在 **Headers** 中找到 `Cookie`，复制整个值

### 4.2 配置Cookie

**方式一：管理界面**（推荐）
- 访问 http://localhost:3000/admin/cookies
- 点击"添加Cookie"按钮
- 粘贴复制的Cookie值

**方式二：环境变量**
```env
# backend/.env
BILIBILI_COOKIE=SESSDATA=xxx; bili_jct=xxx; buvid3=xxx; DedeUserID=xxx
```

### 4.3 监控功能

| 功能 | 说明 |
|------|------|
| 实时状态 | 查看Cookie是否激活、错误次数 |
| 健康检查 | 手动/自动检查Cookie有效性 |
| 自动轮换 | 多Cookie自动轮换，避免限流 |
| 告警通知 | Cookie失效时发送告警（预留接口） |

---

## 五、数据库迁移

由于开发环境使用SQLite，需要执行数据库迁移：

```bash
cd backend
DATABASE_URL="file:./prisma/dev-user.db" npx prisma db push
```

---

## 六、涉及文件

| 文件 | 说明 |
|------|------|
| `backend/prisma/schema.prisma` | 数据库模型定义 |
| `backend/src/services/bilibili-cookie-manager.service.ts` | Cookie管理服务 |
| `backend/src/controllers/bilibili-cookie.controller.ts` | 控制器 |
| `backend/src/routes/bilibili-cookie.routes.ts` | 路由定义 |
| `frontend/src/lib/api/cookie.ts` | API客户端 |
| `frontend/src/app/admin/cookies/page.tsx` | 管理页面 |

---

**文档版本**: v1.0
**创建日期**: 2026-02-23
**最后更新**: 2026-02-23
**维护人**: 开发团队

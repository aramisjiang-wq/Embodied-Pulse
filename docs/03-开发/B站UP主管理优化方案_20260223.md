# B站UP主管理优化方案

**文档版本**: v1.0
**创建日期**: 2026-02-23
**最后更新**: 2026-02-23
**适用范围**: B站UP主管理、视频同步

---

## 一、问题背景

### 1.1 需求描述

1. 管理端只保留30个国内机器人厂家UP主（如逐际动力、宇树等）
2. UP主没有视频数据
3. 用户清楚视频数据自动和手动更新逻辑

### 1.2 发现的问题

| 问题 | 描述 | 影响 |
|------|------|------|
| 删除UP主时没有级联删除视频 | `deleteUploader` 只删除UP主记录，不删除关联视频 | 删除UP主后，视频表中的 `uploaderId` 成为孤儿数据 |
| 标签筛选不一致 | 用户端用 `厂家` 标签，管理端用 `中国厂商/国外厂商/媒体` | 用户端侧栏可能显示错误的UP主 |
| 数据库没有外键约束 | `Video.uploaderId` 和 `bilibili_uploaders.mid` 没有外键关系 | 无法利用数据库级联删除 |
| B站API认证问题 | 获取UP主信息需要Cookie，没有配置时会失败 | 无法获取UP主头像和简介 |

---

## 二、解决方案

### 2.1 架构设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        B站UP主管理架构                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [管理端]                    [后端]                      [用户端]        │
│                                                                         │
│  ┌──────────────┐    POST /admin/bilibili-uploaders                    │
│  │ 添加UP主URL  │ ───────────────────────►  ┌──────────────────────┐   │
│  └──────────────┘                           │ bilibili-uploader    │   │
│                                             │    .service.ts       │   │
│  ┌──────────────┐    POST /sync             │                      │   │
│  │ 同步视频     │ ───────────────────────►  │ 1. 调用B站API        │   │
│  └──────────────┘                           │ 2. 解析视频数据      │   │
│                                             │ 3. 写入Video表       │   │
│  ┌──────────────┐    DELETE /:id            │ 4. 更新video_count   │   │
│  │ 删除UP主     │ ───────────────────────►  │                      │   │
│  │ (级联删除)   │                           │ 级联删除关联视频     │   │
│  └──────────────┘                           └──────────────────────┘   │
│                                                        │               │
│                                                        ▼               │
│                                             ┌──────────────────────┐   │
│                                             │ bilibili_uploaders表 │   │
│                                             │        +             │   │
│                                             │     videos表         │   │
│                                             └──────────────────────┘   │
│                                                        │               │
│                                                        ▼               │
│  ┌──────────────┐    GET /videos               ┌──────────────────────┐
│  │ 视频列表     │ ◄───────────────────────────  │ video.service.ts    │
│  │ 按UP主筛选   │                               │                      │
│  │ (中国厂商)   │                               │ 按uploaderId查询     │   │
│  └──────────────┘                               └──────────────────────┘
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 数据关联关系

```
┌─────────────────────────────────────────────────────────────────┐
│                      数据关联关系图                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  bilibili_uploaders                    videos                   │
│  ┌─────────────────────┐              ┌─────────────────────┐   │
│  │ id (PK)             │              │ id (PK)             │   │
│  │ mid (unique)        │◄─────────────│ uploaderId (FK)     │   │
│  │ name                │   1:N        │ bvid (unique)       │   │
│  │ avatar              │              │ title               │   │
│  │ description         │              │ description         │   │
│  │ tags (JSON)         │              │ uploader            │   │
│  │ is_active           │              │ platform            │   │
│  │ video_count         │              │ viewCount           │   │
│  │ last_sync_at        │              │ playCount           │   │
│  └─────────────────────┘              └─────────────────────┘   │
│                                                                 │
│  关联方式: Video.uploaderId = bilibili_uploaders.mid            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三、具体修改

### 3.1 后端删除逻辑优化

**文件**: `backend/src/controllers/bilibili-uploader.controller.ts`

**修改内容**:

```typescript
/**
 * 删除UP主（同时删除关联的视频）
 */
export async function deleteUploader(req: Request, res: Response, next: NextFunction) {
  try {
    const { id } = req.params;

    const uploader = await userPrisma.bilibiliUploader.findUnique({
      where: { id },
    });

    if (!uploader) {
      return sendError(res, 1005, 'UP主不存在', 404);
    }

    // 先删除关联视频
    const deletedVideos = await userPrisma.video.deleteMany({
      where: { uploaderId: uploader.mid },
    });

    logger.info(`删除UP主 ${uploader.name}(${uploader.mid}) 的 ${deletedVideos.count} 个关联视频`);

    // 再删除UP主
    await userPrisma.bilibiliUploader.delete({
      where: { id },
    });

    sendSuccess(res, { 
      message: '删除成功',
      deletedVideos: deletedVideos.count,
    });
  } catch (error) {
    next(error);
  }
}
```

### 3.2 B站API降级策略

**文件**: `backend/src/services/bilibili-uploader.service.ts`

**修改内容**:

```typescript
/**
 * 获取UP主信息
 * 策略：
 * 1. 先尝试用户信息API（需要Cookie）
 * 2. 失败时降级到视频列表API获取UP主名称（不需要Cookie）
 */
export async function getUploaderInfo(mid: string): Promise<{
  mid: string;
  name: string;
  avatar?: string;
  description?: string;
} | null> {
  try {
    // 策略1：尝试用户信息API
    try {
      const userInfo = await bilibiliAPI.user.getUserInfo(parseInt(mid, 10));
      return {
        mid: String(userInfo.mid),
        name: userInfo.name || '',
        avatar: userInfo.face || undefined,
        description: userInfo.sign || undefined,
      };
    } catch (apiError: any) {
      // 如果是认证错误或限流，尝试降级策略
      const errorCode = apiError?.code || apiError?.statusCode;
      if (errorCode === -401 || errorCode === -799 || errorCode === -352 || errorCode === 412) {
        return await getUploaderInfoFromVideos(mid);
      }
      return await getUploaderInfoFromVideos(mid);
    }
  } catch (error: any) {
    return null;
  }
}

/**
 * 降级策略：从视频列表API获取UP主信息
 */
async function getUploaderInfoFromVideos(mid: string): Promise<{
  mid: string;
  name: string;
  avatar?: string;
  description?: string;
} | null> {
  try {
    const result = await bilibiliAPI.user.getUserVideos(parseInt(mid, 10), 1, 1);
    
    if (result?.list?.vlist && result.list.vlist.length > 0) {
      const firstVideo = result.list.vlist[0];
      const name = firstVideo.author || '';
      
      if (name) {
        return {
          mid,
          name,
          avatar: undefined,
          description: undefined,
        };
      }
    }
    return null;
  } catch (error: any) {
    return null;
  }
}
```

### 3.3 用户端筛选逻辑修正

**文件**: `frontend/src/app/videos/page.tsx`

**修改内容**:

```typescript
// 修改前
const manufacturerUploaders = uploaders.filter((u) => u.tags?.includes('厂家'));

// 修改后
const manufacturerUploaders = uploaders.filter((u) => u.tags?.includes('中国厂商'));
```

### 3.4 数据库清理脚本

**文件**: `backend/src/scripts/cleanup-uploaders.ts`（新建）

**使用方法**:

```bash
cd backend && npx ts-node src/scripts/cleanup-uploaders.ts
```

**功能**:
- 删除所有视频数据
- 删除非「中国厂商」标签的UP主
- 保留带有「中国厂商」标签的UP主

---

## 四、B站Cookie配置指南

### 4.1 为什么需要Cookie

| API端点 | 需要Cookie | 说明 |
|---------|-----------|------|
| `/x/space/acc/info` | 需要 | 获取UP主完整信息（名称、头像、简介） |
| `/x/space/arc/search` | 不需要 | 获取UP主视频列表 |

### 4.2 获取Cookie步骤

1. **打开浏览器**，登录 [bilibili.com](https://www.bilibili.com)
2. **按 F12** 打开开发者工具
3. **切换到 Network 标签页**
4. **刷新页面**，点击任意请求
5. **在 Headers 中找到 Cookie**，复制整个值

### 4.3 配置方式

**方式一：环境变量**（推荐用于生产环境）

```env
# backend/.env
BILIBILI_COOKIE=SESSDATA=xxx; bili_jct=xxx; buvid3=xxx; DedeUserID=xxx
```

**方式二：管理界面**（推荐用于开发环境）

- 访问 http://localhost:3000/admin/cookies
- 点击"添加Cookie"按钮
- 粘贴复制的Cookie值

### 4.4 注意事项

- Cookie有效期通常1-3个月，建议定期更新
- 无需申请官方API，只需从浏览器复制Cookie即可
- 支持多Cookie轮换，避免单个Cookie被限流

---

## 五、验证清单

### 5.1 功能验证

- [ ] 管理端：删除UP主时，关联视频也被删除
- [ ] 管理端：添加UP主时，即使没有Cookie也能获取名称（降级策略）
- [ ] 用户端：侧栏只显示「中国厂商」标签的UP主
- [ ] 用户端：点击UP主可以正确筛选视频

### 5.2 数据验证

- [ ] 数据库中只保留「中国厂商」标签的UP主
- [ ] 视频表中的 `uploaderId` 都能对应到有效的UP主
- [ ] UP主的 `video_count` 与实际视频数量一致

---

## 六、涉及文件清单

| 文件 | 修改类型 | 说明 |
|------|---------|------|
| `backend/src/controllers/bilibili-uploader.controller.ts` | 修改 | 删除逻辑优化 |
| `backend/src/services/bilibili-uploader.service.ts` | 修改 | API降级策略 |
| `backend/src/services/bilibili/types.ts` | 修改 | 类型定义补充 |
| `backend/src/scripts/cleanup-uploaders.ts` | 新增 | 数据库清理脚本 |
| `frontend/src/app/videos/page.tsx` | 修改 | 筛选逻辑修正 |
| `frontend/src/app/videos/page.module.css` | 修改 | 注释更新 |
| `frontend/src/app/admin/cookies/page.tsx` | 修改 | 使用说明优化 |

---

**文档版本**: v1.0
**创建日期**: 2026-02-23
**最后更新**: 2026-02-23
**维护人**: 开发团队

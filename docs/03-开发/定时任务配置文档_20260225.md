# 定时任务配置文档

**文档版本**: v1.0
**创建日期**: 2026-02-24
**最后更新**: 2026-02-24
**维护人**: 开发团队

---

## 概述

本文档详细说明 Embodied Pulse 项目的定时任务配置，包括任务列表、同步规则、稳定性措施等内容。

---

## 定时任务配置汇总

### 任务列表

| 任务 | 时间 | 同步规则 | 数量限制 |
|------|------|----------|----------|
| **arXiv论文同步** | 每6小时 | 全量，所有8个分类 | 每分类最多100篇 |
| **论文关键词同步** | 每6小时 | 最近30天，所有关键词 | 每关键词最多100篇 |
| **Bilibili关键词同步** | 每6小时 | 最近30天，所有关键词 | 每关键词最多100条 |
| **Semantic Scholar同步** | 每12小时 | 补充同步，不限数量 | 每次最多100篇 |
| **GitHub项目同步** | 每8小时 | embodied intelligence | 最多100个 |
| **Bilibili视频同步** | 每12小时 | UP主视频 | 最高100条 |
| **HuggingFace模型同步** | 每12小时 | robotics | 最多100个 |
| **全量数据同步** | 每天凌晨2点 | 所有数据源 | 每任务最高100个 |
| **逐际动力岗位** | 每天凌晨3点 | - | - |

---

## 详细配置说明

### 1. arXiv论文同步

**执行时间**: 每6小时（0:00, 6:00, 12:00, 18:00）

**同步规则**:
- 遍历所有8个分类，每个分类最多100篇
- 不限制总数量
- 按提交时间倒序排列

**分类列表**:
| 分类代码 | 分类名称 |
|---------|---------|
| cs.AI | 人工智能 |
| cs.RO | 机器人 |
| cs.CV | 计算机视觉 |
| cs.LG | 机器学习 |
| cs.CL | 计算与语言 |
| cs.NE | 神经与进化计算 |
| cs.MA | 多智能体系统 |
| eess.SY | 系统与控制 |

**API限制**:
- arXiv API 无需认证
- 建议请求间隔 ≥ 3秒
- 单次请求最多返回 2000 条

---

### 2. 论文关键词同步

**执行时间**: 每6小时（6:30, 12:30, 18:30, 0:30）

**同步规则**:
- 从数据库读取所有启用的关键词
- 每个关键词最多同步100篇论文
- 时间范围：最近30天
- 不限制总数量

**关键词来源**:
- 管理员配置的关键词
- 用户订阅的关键词

---

### 3. Bilibili关键词同步

**执行时间**: 每6小时（6:45, 12:45, 18:45, 0:45）

**同步规则**:
- 从数据库读取所有启用的关键词
- 每个关键词最多同步100条视频
- 时间范围：最近30天
- 不限制总数量

**注意事项**:
- 需要有效的Bilibili Cookie
- Cookie有效期通常1-3个月
- 建议定期更新Cookie

---

### 4. Semantic Scholar同步

**执行时间**: 每12小时（12:30, 0:30）

**同步规则**:
- 搜索关键词：`embodied AI OR robotics OR computer vision OR machine learning`
- 每次最多100篇
- 不限制总数量，依次补充
- 年份筛选：当前年份
- 领域筛选：Computer Science, Robotics

**API限制**:
- 免费版：100请求/5分钟
- 建议申请API Key提升限制
- 环境变量：`SEMANTIC_SCHOLAR_API_KEY`

---

### 5. GitHub项目同步

**执行时间**: 每8小时（0:00, 8:00, 16:00）

**同步规则**:
- 搜索关键词：`embodied intelligence`
- 最多100个项目
- 按stars排序

**API限制**:
- 未认证：60请求/小时
- 已认证：5000请求/小时
- 环境变量：`GITHUB_TOKEN`

---

### 6. Bilibili视频同步

**执行时间**: 每12小时（0:00, 12:00）

**同步规则**:
- 根据数据库中配置的UP主列表同步
- 最高100条视频
- 支持Cookie轮换和风控处理

---

### 7. HuggingFace模型同步

**执行时间**: 每12小时（12:30, 0:30）

**同步规则**:
- 搜索关键词：`robotics`
- 最多100个模型
- 按downloads排序

---

### 8. 全量数据同步

**执行时间**: 每天凌晨2点

**同步内容**:
1. arXiv论文：8个分类，每分类最多100篇
2. GitHub项目：embodied intelligence，最多100个
3. HuggingFace模型：robotics，最多100个
4. Bilibili视频：UP主视频，最多100条
5. 论文关键词：所有关键词，每关键词最多100篇
6. Bilibili关键词：所有关键词，每关键词最多100条
7. Semantic Scholar：补充同步，每次最多100篇

---

### 9. 逐际动力岗位同步

**执行时间**: 每天凌晨3点

**同步规则**:
- 从逐际动力官网抓取招聘信息
- 自动解析岗位详情

---

## 稳定性措施

### 请求间隔控制

```typescript
const REQUEST_DELAY = {
  betweenCategories: 3000,  // 分类之间间隔3秒
  afterError: 5000,         // 错误后等待5秒
  betweenKeywords: 2000,    // 关键词之间间隔2秒
};
```

### 错误处理

1. **独立执行**: 每个任务独立执行，失败不影响其他任务
2. **重试机制**: Semantic Scholar最多重试3次
3. **日志记录**: 详细的日志记录，便于问题排查

### 限流保护

| API | 限流策略 | 应对措施 |
|-----|---------|---------|
| arXiv | 无明确限制 | 请求间隔3秒 |
| Semantic Scholar | 100请求/5分钟 | 请求间隔3.5秒，支持API Key |
| GitHub | 60请求/小时 | 建议配置Token |
| Bilibili | 风控机制 | Cookie轮换，智能限流 |

---

## 配置文件位置

**主要文件**: `backend/src/services/sync/cron.ts`

**相关服务**:
- `backend/src/services/sync/arxiv.sync.ts` - arXiv同步
- `backend/src/services/sync/paper-search.sync.ts` - 论文关键词同步
- `backend/src/services/sync/bilibili-search.sync.ts` - Bilibili关键词同步
- `backend/src/services/sync/semantic-scholar.sync.ts` - Semantic Scholar同步
- `backend/src/services/sync/bilibili.sync.ts` - Bilibili视频同步
- `backend/src/services/sync/github.sync.ts` - GitHub同步
- `backend/src/services/sync/huggingface.sync.ts` - HuggingFace同步

---

## 手动触发同步

### 管理端API

```bash
# 获取管理员Token
TOKEN=$(curl -s -X POST "http://localhost:3001/api/auth/admin/login" \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@embodiedpulse.com", "password": "admin123456"}' \
  | jq -r '.data.token')

# 触发全量同步
curl -X POST "http://localhost:3001/api/admin/sync/all" \
  -H "Authorization: Bearer $TOKEN"

# 触发arXiv同步
curl -X POST "http://localhost:3001/api/admin/sync/arxiv" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"query": "embodied AI", "maxResults": 100}'

# 触发Bilibili同步
curl -X POST "http://localhost:3001/api/admin/sync/bilibili" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"maxResults": 100}'
```

---

## 监控与告警

### 日志查看

```bash
# 查看后端日志
tail -f backend/logs/app.log | grep "定时任务"

# 查看同步结果
tail -f backend/logs/app.log | grep "同步完成"
```

### 关键指标

- 同步成功率
- 同步耗时
- API错误次数
- 数据增量

---

## 常见问题

### Q1: arXiv同步失败怎么办？

**可能原因**:
- 网络连接问题
- arXiv API临时不可用

**解决方案**:
- 检查网络连接
- 稍后重试
- 查看日志获取详细错误信息

### Q2: Bilibili同步返回0条数据？

**可能原因**:
- Cookie过期或无效
- 关键词未配置

**解决方案**:
- 更新Bilibili Cookie
- 检查数据库中的关键词配置

### Q3: Semantic Scholar限流怎么办？

**解决方案**:
- 申请API Key：https://www.semanticscholar.org/product/api
- 配置环境变量：`SEMANTIC_SCHOLAR_API_KEY`
- 等待5分钟后重试

---

## 更新历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.0 | 2026-02-24 | 初始版本，完整定时任务配置文档 |

---

**文档版本**: v1.0
**创建日期**: 2026-02-24
**最后更新**: 2026-02-24
**维护人**: 开发团队

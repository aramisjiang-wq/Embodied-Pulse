# 代码与数据库一致性校验报告

**生成时间**: 2026-02-27  
**校验范围**: GitHub 仓库 vs 本地开发环境  
**校验类型**: 代码文件一致性 + 数据库数据同步

---

## 一、代码文件一致性校验

### 1.1 Git 仓库状态分析

#### 本地分支结构
| 分支名 | 类型 | 状态 |
|--------|------|------|
| develop | 本地分支 | 已存在 |
| feature/news-page-ssr-fix | 本地分支 | 当前活动分支 (HEAD) |
| backup/analysis-report-20260224 | 本地分支 | 历史备份 |
| bugfix/notification-fix | 本地分支 | 已存在 |
| feature/data-sync-enhancement | 本地分支 | 已存在 |
| hotfix/security-patch | 本地分支 | 已存在 |

#### 远程分支结构
| 分支名 | 状态 |
|--------|------|
| origin/backup/analysis-report-20260224 | 仅此分支存在于远程 |

#### ⚠️ 关键发现
1. **远程仓库缺少 main 分支**: main 分支未在远程仓库中创建
2. **远程仓库缺少 develop 分支**: 本地 develop 分支尚未推送到远程
3. **本地未推送的分支**: feature/news-page-ssr-fix, bugfix/notification-fix, feature/data-sync-enhancement, hotfix/security-patch

### 1.2 本地未提交更改

| 文件 | 状态 | 说明 |
|------|------|------|
| backend/prisma/dev-user.db | 已修改 | 数据库文件 (0 字节变化) |
| CONSISTENCY_CHECK_REPORT.md | 未跟踪 | 新创建的报告文档 |
| docs/00-项目/AI工程团队项目调研报告/ | 未跟踪 | 新创建的文档目录 |

### 1.3 代码文件一致性结论

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 本地 vs 远程 (develop) | ⚠️ 不一致 | develop 分支未推送到远程 |
| 本地 vs 远程 (main) | ⚠️ 不存在 | main 分支未创建 |
| 本地未提交文件 | ✅ 已记录 | 仅数据库文件有微小变化 |

---

## 二、数据库数据同步分析

### 2.1 本地数据库文件清单

| 数据库文件 | 路径 | 大小 | 版本控制状态 |
|------------|------|------|--------------|
| dev-user.db | backend/prisma/dev-user.db | 6.3MB | ⚠️ 被忽略但仍被追踪 |
| dev-admin.db | backend/prisma/dev-admin.db | 610KB | ⚠️ 被忽略但仍被追踪 |
| dev.db | backend/prisma/dev.db | - | ⚠️ 被忽略但仍被追踪 |
| dev-user.db | backend/prisma/prisma/dev-user.db | - | ⚠️ 被忽略但仍被追踪 |
| dev-admin.db | backend/prisma/prisma/dev-admin.db | - | ⚠️ 被忽略但仍被追踪 |
| user.db | backend/prisma/user.db | - | ⚠️ 被忽略但仍被追踪 |

### 2.2 .gitignore 配置检查

```gitignore
# 第 49 行
*.db
```

✅ 规则已配置: `*.db` 模式用于忽略所有 .db 文件

### 2.3 Git 追踪的数据库文件

以下数据库文件已被 .gitignore 规则忽略，但仍在 Git 版本控制中：

```
backend/prisma/dev-admin.db
backend/prisma/dev-user.db
backend/prisma/dev-user.db.backup
backend/prisma/dev.db
backend/prisma/dev.db.backup
backend/prisma/dev.db.current
backend/prisma/prisma/dev-admin.db
backend/prisma/prisma/dev-user.db
backend/prisma/user.db
```

### 2.4 数据库同步方案

#### ⚠️ 重要警告
由于以下原因，数据库文件**不应**纳入版本控制：
1. SQLite 数据库文件是二进制格式，无法有效合并
2. 数据库包含生产数据，不应公开暴露
3. 多开发环境下数据库同步会导致冲突

#### 推荐同步方式

**方式一：直接文件复制 (开发环境)**
```bash
# 从本地上传到服务器
scp backend/prisma/dev-user.db user@server:/path/to/project/backend/prisma/
scp backend/prisma/dev-admin.db user@server:/path/to/project/backend/prisma/
```

**方式二：数据库导出/导入 (生产环境)**
```bash
# 导出SQL (本地)
sqlite3 dev-user.db ".dump" > dump.sql

# 导入SQL (服务器)
sqlite3 dev-user.db < dump.sql
```

---

## 三、差异详情记录

### 3.1 本地开发环境文件结构

**核心配置文件 (.env)**
| 变量 | 本地值 | 远程预期值 |
|------|--------|-----------|
| DATABASE_URL | file:./prisma/dev-user.db | postgresql://... |
| ADMIN_DATABASE_URL | file:./prisma/dev-admin.db | postgresql://... |

### 3.2 本地数据库内容摘要

**用户数据库 (dev-user.db)**
- 表: users, papers, videos, github_repos, huggingface_models, news, jobs, bilibili_uploaders 等
- 用途: 用户端业务数据

**管理数据库 (dev-admin.db)**
- 表: admins, admin_sessions, admin_settings 等
- 用途: 管理端认证和配置数据

---

## 四、同步操作日志

### 4.1 待执行操作

| 操作 | 优先级 | 状态 |
|------|--------|------|
| 创建 main 分支 | 高 | ⏳ 待执行 |
| 推送 develop 分支 | 高 | ⏳ 待执行 |
| 推送 feature 分支 | 中 | ⏳ 待执行 |
| 从 Git 移除数据库文件 | 中 | ⏳ 待确认 |

### 4.2 建议的执行顺序

1. **创建 main 分支**: 基于当前稳定代码创建 main 分支
2. **推送 develop**: `git push origin develop`
3. **推送 feature**: `git push origin feature/news-page-ssr-fix`
4. **清理数据库追踪**: 使用 `git rm --cached` 移除数据库文件追踪

---

## 五、结论与建议

### 5.1 代码文件一致性

| 项目 | 状态 |
|------|------|
| 主分支 (main) | ❌ 远程不存在 |
| 开发分支 (develop) | ❌ 未推送 |
| 功能分支 (feature/*) | ⚠️ 部分未推送 |

**建议**: 立即创建并推送 main 和 develop 分支到远程仓库

### 5.2 数据库同步

| 项目 | 状态 |
|------|------|
| 本地数据库文件 | ✅ 存在 |
| 远程数据库 | ❌ 不存在 (不应存在) |
| 同步机制 | ⚠️ 需手动执行 |

**建议**: 
1. 不要将数据库文件纳入 Git 版本控制
2. 使用 scp 或 SQL dump 方式手动同步数据库
3. 从 Git 索引中移除已追踪的 .db 文件

### 5.3 下一步行动

- [ ] 创建 main 分支并推送到远程
- [ ] 推送 develop 分支到远程
- [ ] 推送所有功能分支到远程
- [ ] 从 Git 移除数据库文件追踪
- [ ] 确认服务器部署时手动同步数据库

---

*报告生成工具: 自动代码与数据库一致性校验*

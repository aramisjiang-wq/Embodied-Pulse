# Embodied Pulse 运维手册

**文档版本**: v1.0
**创建日期**: 2026-02-23
**最后更新**: 2026-02-23
**适用角色**: 运维人员

---

## 目录

1. [服务概览](#一服务概览)
2. [日常运维](#二日常运维)
3. [故障排查](#三故障排查)
4. [数据备份与恢复](#四数据备份与恢复)
5. [安全运维](#五安全运维)
6. [性能监控](#六性能监控)
7. [应急处理](#七应急处理)

---

## 一、服务概览

### 1.1 服务架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        服务架构图                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐      │
│   │   Nginx     │────▶│  Frontend   │     │   Backend   │      │
│   │   :443/80   │     │   :3000     │     │   :3001     │      │
│   └─────────────┘     └─────────────┘     └──────┬──────┘      │
│                                                  │              │
│                           ┌──────────────────────┼──────────┐   │
│                           │                      │          │   │
│                           ▼                      ▼          ▼   │
│                    ┌─────────────┐      ┌─────────────┐ ┌─────┐│
│                    │ PostgreSQL  │      │    Redis    │ │文件 ││
│                    │   :5432     │      │   :6379     │ │存储 ││
│                    └─────────────┘      └─────────────┘ └─────┘│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 服务端口

| 服务 | 端口 | 说明 |
|------|------|------|
| Nginx | 80/443 | 反向代理、SSL终止 |
| Frontend | 3000 | Next.js 应用 |
| Backend | 3001 | Express API |
| PostgreSQL | 5432 | 主数据库 |
| Redis | 6379 | 缓存/队列 |

### 1.3 服务依赖关系

```
Nginx → Frontend → Backend → PostgreSQL
                  Backend → Redis
```

---

## 二、日常运维

### 2.1 服务管理命令

#### 启动服务

```bash
# 启动所有服务
pm2 start ecosystem.config.js

# 启动单个服务
pm2 start backend
pm2 start frontend

# 使用 systemd（生产环境推荐）
sudo systemctl start embodied-pulse-backend
sudo systemctl start embodied-pulse-frontend
```

#### 停止服务

```bash
# 停止所有服务
pm2 stop all

# 停止单个服务
pm2 stop backend
pm2 stop frontend

# 使用 systemd
sudo systemctl stop embodied-pulse-backend
sudo systemctl stop embodied-pulse-frontend
```

#### 重启服务

```bash
# 重启所有服务
pm2 restart all

# 重启单个服务
pm2 restart backend

# 平滑重启（零停机）
pm2 reload backend
```

#### 查看服务状态

```bash
# PM2 状态
pm2 status
pm2 info backend
pm2 monit

# Systemd 状态
sudo systemctl status embodied-pulse-backend
sudo systemctl status embodied-pulse-frontend

# 端口占用检查
lsof -i :3000
lsof -i :3001
lsof -i :5432
lsof -i :6379
```

### 2.2 日志管理

#### 日志位置

| 服务 | 日志路径 |
|------|----------|
| Backend | `/var/log/embodied-pulse/backend.log` |
| Frontend | `/var/log/embodied-pulse/frontend.log` |
| Nginx | `/var/log/nginx/access.log` |
| Nginx Error | `/var/log/nginx/error.log` |
| PostgreSQL | `/var/log/postgresql/` |

#### 日志查看命令

```bash
# PM2 日志
pm2 logs backend
pm2 logs frontend
pm2 logs --lines 100

# 实时查看日志
tail -f /var/log/embodied-pulse/backend.log

# 查看最近错误
grep -i error /var/log/embodied-pulse/backend.log | tail -50

# 查看访问日志
tail -f /var/log/nginx/access.log

# 日志大小检查
du -sh /var/log/embodied-pulse/
du -sh /var/log/nginx/
```

#### 日志轮转配置

```bash
# /etc/logrotate.d/embodied-pulse
/var/log/embodied-pulse/*.log {
    daily
    rotate 14
    compress
    delaycompress
    missingok
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        pm2 reloadLogs
    endscript
}
```

### 2.3 定时任务管理

#### 数据同步任务

```bash
# 查看定时任务
crontab -l

# 编辑定时任务
crontab -e

# 当前配置的任务
# ArXiv 论文同步 - 每小时
0 * * * * cd /opt/embodied-pulse/backend && npm run sync:papers

# GitHub 仓库同步 - 每15分钟
*/15 * * * * cd /opt/embodied-pulse/backend && npm run sync:repos

# B站视频同步 - 每小时
0 * * * * cd /opt/embodied-pulse/backend && npm run sync:videos

# HuggingFace 模型同步 - 每6小时
0 */6 * * * cd /opt/embodied-pulse/backend && npm run sync:models

# 职位同步 - 每天
0 8 * * * cd /opt/embodied-pulse/backend && npm run sync:jobs
```

---

## 三、故障排查

### 3.1 服务无法启动

#### 检查步骤

```bash
# 1. 检查端口占用
lsof -i :3000
lsof -i :3001

# 2. 检查进程
ps aux | grep node

# 3. 检查日志
pm2 logs backend --lines 100

# 4. 检查配置文件
cat /opt/embodied-pulse/backend/.env

# 5. 检查依赖
cd /opt/embodied-pulse/backend && npm install
```

#### 常见原因

| 问题 | 解决方案 |
|------|----------|
| 端口被占用 | `kill -9 <PID>` 或修改端口 |
| 环境变量缺失 | 检查 `.env` 文件 |
| 依赖缺失 | `npm install` |
| 数据库连接失败 | 检查 PostgreSQL 状态 |
| Redis 连接失败 | 检查 Redis 状态 |

### 3.2 数据库连接失败

#### 检查步骤

```bash
# 1. 检查 PostgreSQL 状态
sudo systemctl status postgresql

# 2. 检查数据库连接
psql -U embodied_pulse -d embodied_pulse -h localhost

# 3. 检查连接数
SELECT count(*) FROM pg_stat_activity;

# 4. 检查连接配置
cat /opt/embodied-pulse/backend/.env | grep DATABASE

# 5. 检查防火墙
sudo ufw status
```

#### 常见解决方案

```bash
# 重启 PostgreSQL
sudo systemctl restart postgresql

# 清理空闲连接
SELECT pg_terminate_backend(pid) FROM pg_stat_activity 
WHERE state = 'idle' AND pid <> pg_backend_pid();

# 调整最大连接数
# /etc/postgresql/15/main/postgresql.conf
max_connections = 200
```

### 3.3 Redis 连接失败

#### 检查步骤

```bash
# 1. 检查 Redis 状态
sudo systemctl status redis

# 2. 测试连接
redis-cli ping

# 3. 检查内存使用
redis-cli info memory

# 4. 检查配置
cat /etc/redis/redis.conf | grep bind
```

#### 常见解决方案

```bash
# 重启 Redis
sudo systemctl restart redis

# 清理缓存
redis-cli FLUSHALL

# 调整内存限制
# /etc/redis/redis.conf
maxmemory 2gb
maxmemory-policy allkeys-lru
```

### 3.4 API 响应慢

#### 检查步骤

```bash
# 1. 检查服务器负载
top
htop

# 2. 检查内存使用
free -h

# 3. 检查磁盘 I/O
iostat -x 1

# 4. 检查数据库慢查询
SELECT * FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;

# 5. 检查 Redis 命中率
redis-cli info stats | grep keyspace
```

#### 优化方案

| 问题 | 解决方案 |
|------|----------|
| 数据库慢查询 | 添加索引、优化SQL |
| 内存不足 | 增加服务器内存、优化缓存策略 |
| 高并发 | 增加实例、负载均衡 |
| 磁盘 I/O 高 | 使用 SSD、优化日志写入 |

### 3.5 前端页面空白

#### 检查步骤

```bash
# 1. 检查前端服务状态
pm2 status frontend

# 2. 检查构建产物
ls -la /opt/embodied-pulse/frontend/.next/

# 3. 检查 Nginx 配置
nginx -t
cat /etc/nginx/sites-enabled/embodied-pulse

# 4. 检查浏览器控制台错误
# 打开开发者工具 → Console

# 5. 检查 API 连接
curl https://api.embodiedpulse.com/health
```

#### 常见解决方案

```bash
# 重新构建前端
cd /opt/embodied-pulse/frontend
npm run build
pm2 restart frontend

# 清理缓存重新构建
rm -rf .next
npm run build
pm2 restart frontend
```

---

## 四、数据备份与恢复

### 4.1 数据库备份

#### 手动备份

```bash
# 完整备份
pg_dump -U embodied_pulse -h localhost embodied_pulse > backup_$(date +%Y%m%d).sql

# 压缩备份
pg_dump -U embodied_pulse -h localhost embodied_pulse | gzip > backup_$(date +%Y%m%d).sql.gz

# 仅结构备份
pg_dump -U embodied_pulse -h localhost --schema-only embodied_pulse > schema.sql

# 仅数据备份
pg_dump -U embodied_pulse -h localhost --data-only embodied_pulse > data.sql
```

#### 自动备份脚本

```bash
#!/bin/bash
# /opt/scripts/backup.sh

BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

# 创建备份目录
mkdir -p $BACKUP_DIR

# 数据库备份
pg_dump -U embodied_pulse -h localhost embodied_pulse | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# 清理旧备份
find $BACKUP_DIR -name "db_*.sql.gz" -mtime +$RETENTION_DAYS -delete

# 上传到云存储（可选）
# aws s3 cp $BACKUP_DIR/db_$DATE.sql.gz s3://backups/

echo "Backup completed: $BACKUP_DIR/db_$DATE.sql.gz"
```

#### 定时备份

```bash
# 每天凌晨2点备份
0 2 * * * /opt/scripts/backup.sh >> /var/log/embodied-pulse/backup.log 2>&1
```

### 4.2 数据库恢复

```bash
# 从备份恢复
gunzip -c backup_20260223.sql.gz | psql -U embodied_pulse -h localhost embodied_pulse

# 恢复前先停止服务
pm2 stop backend

# 恢复后重启服务
pm2 start backend
```

### 4.3 Redis 备份

```bash
# 手动触发 RDB 快照
redis-cli BGSAVE

# 备份文件位置
cp /var/lib/redis/dump.rdb /opt/backups/redis_$(date +%Y%m%d).rdb

# 从 RDB 恢复
# 1. 停止 Redis
sudo systemctl stop redis
# 2. 复制备份文件
cp /opt/backups/redis_20260223.rdb /var/lib/redis/dump.rdb
# 3. 启动 Redis
sudo systemctl start redis
```

---

## 五、安全运维

### 5.1 安全检查清单

| 检查项 | 频率 | 命令 |
|--------|------|------|
| 系统更新 | 每周 | `apt update && apt upgrade` |
| 安全漏洞 | 每周 | `npm audit` |
| SSL证书 | 每月 | `certbot certificates` |
| 防火墙规则 | 每月 | `sudo ufw status` |
| 登录日志 | 每天 | `last -n 20` |
| 失败登录 | 每天 | `grep "Failed password" /var/log/auth.log` |

### 5.2 SSL证书管理

```bash
# 查看证书状态
certbot certificates

# 手动续期
certbot renew

# 测试续期（不实际执行）
certbot renew --dry-run

# 自动续期（已配置在 cron）
# /etc/cron.d/certbot
0 0 * * * root certbot renew --quiet
```

### 5.3 防火墙配置

```bash
# 查看状态
sudo ufw status

# 允许必要端口
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS

# 禁止其他端口
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 启用防火墙
sudo ufw enable
```

### 5.4 访问控制

```bash
# 限制 SSH 访问 IP
# /etc/ssh/sshd_config
AllowUsers admin@192.168.1.0/24

# 禁用 root 登录
PermitRootLogin no

# 使用密钥登录
PasswordAuthentication no
```

---

## 六、性能监控

### 6.1 系统监控

```bash
# CPU 使用率
top -bn1 | grep "Cpu(s)"

# 内存使用
free -h

# 磁盘使用
df -h

# 网络流量
iftop

# 综合监控
htop
```

### 6.2 应用监控

```bash
# PM2 监控
pm2 monit

# 进程详情
pm2 show backend

# 内存使用趋势
pm2 logs backend --lines 0 & watch -n 1 'pm2 show backend | grep memory'

# 请求统计
pm2 show backend | grep restarts
```

### 6.3 数据库监控

```sql
-- 连接数
SELECT count(*) FROM pg_stat_activity;

-- 慢查询
SELECT query, calls, total_time, mean_time 
FROM pg_stat_statements 
ORDER BY mean_time DESC LIMIT 10;

-- 表大小
SELECT relname, pg_size_pretty(pg_total_relation_size(relid)) 
FROM pg_catalog.pg_statio_user_tables 
ORDER BY pg_total_relation_size(relid) DESC;

-- 索引使用率
SELECT indexrelname, idx_scan, idx_tup_read, idx_tup_fetch 
FROM pg_stat_user_indexes;
```

### 6.4 Redis 监控

```bash
# 基本信息
redis-cli info

# 内存使用
redis-cli info memory

# 命令统计
redis-cli info commandstats

# 实时监控
redis-cli monitor

# 慢查询日志
redis-cli slowlog get 10
```

---

## 七、应急处理

### 7.1 服务宕机

```bash
# 1. 检查服务状态
pm2 status
sudo systemctl status embodied-pulse-backend

# 2. 查看错误日志
pm2 logs backend --lines 100

# 3. 尝试重启
pm2 restart backend

# 4. 如果无法启动，检查依赖服务
sudo systemctl status postgresql
sudo systemctl status redis

# 5. 必要时回滚版本
cd /opt/embodied-pulse
git checkout <previous-version>
npm install
npm run build
pm2 restart all
```

### 7.2 数据库故障

```bash
# 1. 检查 PostgreSQL 状态
sudo systemctl status postgresql

# 2. 查看错误日志
tail -100 /var/log/postgresql/postgresql-15-main.log

# 3. 尝试重启
sudo systemctl restart postgresql

# 4. 如果无法启动，检查磁盘空间
df -h

# 5. 从备份恢复
gunzip -c /opt/backups/db_latest.sql.gz | psql -U embodied_pulse embodied_pulse
```

### 7.3 磁盘空间不足

```bash
# 1. 检查磁盘使用
df -h

# 2. 查找大文件
du -sh /* | sort -rh | head -20

# 3. 清理日志
find /var/log -name "*.log" -mtime +7 -delete

# 4. 清理 npm 缓存
npm cache clean --force

# 5. 清理旧备份
find /opt/backups -name "*.sql.gz" -mtime +30 -delete

# 6. 清理 Docker（如果使用）
docker system prune -a
```

### 7.4 内存溢出

```bash
# 1. 检查内存使用
free -h
top

# 2. 重启 Node.js 进程
pm2 restart all

# 3. 清理 Redis 缓存
redis-cli FLUSHALL

# 4. 调整 Node.js 内存限制
# ecosystem.config.js
module.exports = {
  apps: [{
    name: 'backend',
    script: 'dist/index.js',
    max_memory_restart: '1G',
    node_args: '--max-old-space-size=2048'
  }]
}
```

### 7.5 紧急联系

| 角色 | 联系方式 |
|------|----------|
| 主要运维 | ops@embodiedpulse.com |
| 开发负责人 | dev@embodiedpulse.com |
| 安全负责人 | security@embodiedpulse.com |

---

## 附录

### A. 常用命令速查

```bash
# 服务管理
pm2 status                    # 查看服务状态
pm2 logs backend              # 查看日志
pm2 restart all               # 重启所有服务
pm2 monit                     # 实时监控

# 数据库
psql -U embodied_pulse -d embodied_pulse   # 连接数据库
pg_dump embodied_pulse > backup.sql        # 备份数据库

# Redis
redis-cli ping                # 测试连接
redis-cli info memory         # 内存信息
redis-cli FLUSHALL            # 清空缓存

# 系统
htop                          # 系统监控
df -h                         # 磁盘空间
free -h                       # 内存使用
```

### B. 配置文件位置

| 配置 | 路径 |
|------|------|
| Backend .env | `/opt/embodied-pulse/backend/.env` |
| Nginx | `/etc/nginx/sites-enabled/embodied-pulse` |
| PostgreSQL | `/etc/postgresql/15/main/postgresql.conf` |
| Redis | `/etc/redis/redis.conf` |
| PM2 | `/opt/embodied-pulse/ecosystem.config.js` |

---

**文档版本**: v1.0
**创建日期**: 2026-02-23
**最后更新**: 2026-02-23
**维护人**: 运维团队

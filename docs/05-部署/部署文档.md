# Embodied Pulse 部署文档

**产品名称**：Embodied Pulse（具身智能脉搏）  
**文档类型**：部署指南  
**版本**：v2.0  
**更新日期**：2026-02-17  
**适用对象**：运维人员、开发者  

---

## 目录

1. [部署架构](#1-部署架构)
2. [环境准备](#2-环境准备)
3. [部署方式](#3-部署方式)
4. [配置说明](#4-配置说明)
5. [监控与维护](#5-监控与维护)
6. [故障排查](#6-故障排查)
7. [更新与回滚](#7-更新与回滚)

---

## 1. 部署架构

### 1.1 生产环境架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              生产环境架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                  │
│  │   用户请求   │────▶│   Nginx     │────▶│   前端服务   │                  │
│  └─────────────┘     │  反向代理    │     │  Next.js    │                  │
│                      └──────┬──────┘     └─────────────┘                  │
│                             │                                               │
│                             ▼                                               │
│                      ┌─────────────┐                                       │
│                      │   后端服务   │                                       │
│                      │  Express    │                                       │
│                      └──────┬──────┘                                       │
│                             │                                               │
│              ┌──────────────┼──────────────┐                               │
│              ▼              ▼              ▼                               │
│       ┌───────────┐  ┌───────────┐  ┌───────────┐                         │
│       │PostgreSQL │  │   Redis   │  │ 文件存储   │                         │
│       │  主数据库  │  │  缓存/队列 │  │  (OSS)    │                         │
│       └───────────┘  └───────────┘  └───────────┘                         │
│                                                                             │
│                      ┌─────────────┐                                       │
│                      │  同步服务    │                                       │
│                      │ Bull Queue  │                                       │
│                      └─────────────┘                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 开发环境架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              开发环境架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐     ┌─────────────┐                                       │
│  │  浏览器访问  │────▶│   前端服务   │  端口: 3000                          │
│  └─────────────┘     │  Next.js    │                                       │
│                      └──────┬──────┘                                       │
│                             │                                               │
│                             ▼                                               │
│                      ┌─────────────┐                                       │
│                      │   后端服务   │  端口: 3001                          │
│                      │  Express    │                                       │
│                      └──────┬──────┘                                       │
│                             │                                               │
│              ┌──────────────┴──────────────┐                               │
│              ▼                             ▼                               │
│       ┌───────────┐                 ┌───────────┐                         │
│       │  SQLite   │                 │   Redis   │                         │
│       │ dev-user  │                 │  (可选)    │                         │
│       │ dev-admin │                 └───────────┘                         │
│       └───────────┘                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 服务器要求

**生产环境**：

| 组件 | 最低配置 | 推荐配置 |
|------|----------|----------|
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 存储 | 50GB SSD | 100GB+ SSD |
| 带宽 | 5Mbps | 10Mbps+ |

**开发环境**：

| 组件 | 配置 |
|------|------|
| CPU | 2核+ |
| 内存 | 4GB+ |
| 存储 | 20GB+ |

---

## 2. 环境准备

### 2.1 安装依赖（Ubuntu/Debian）

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Node.js 20.x
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# 安装PostgreSQL（生产环境）
sudo apt install -y postgresql postgresql-contrib

# 安装Redis
sudo apt install -y redis-server

# 安装Nginx
sudo apt install -y nginx

# 安装PM2
sudo npm install -g pm2
```

### 2.2 安装依赖（macOS 开发环境）

```bash
# 安装Homebrew（如未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装Node.js
brew install node@20

# 安装Redis（可选）
brew install redis
brew services start redis

# 安装PostgreSQL（生产环境测试用）
brew install postgresql@15
brew services start postgresql@15
```

### 2.3 数据库配置（生产环境 - PostgreSQL）

```bash
# 创建数据库用户
sudo -u postgres psql
CREATE USER embodied WITH PASSWORD 'your_secure_password';
CREATE DATABASE embodied_pulse OWNER embodied;
GRANT ALL PRIVILEGES ON DATABASE embodied_pulse TO embodied;
\q

# 配置Redis
sudo systemctl enable redis-server
sudo systemctl start redis-server
```

### 2.4 数据库配置（开发环境 - SQLite）

开发环境使用 SQLite，无需额外配置。数据库文件位于：
- 用户数据库：`backend/prisma/dev-user.db`
- 管理数据库：`backend/prisma/dev-admin.db`

---

## 3. 部署方式

### 3.1 方式一：传统部署（PM2）

#### 3.1.1 获取代码

```bash
# 克隆项目
git clone <repository-url> /var/www/embodied-pulse
cd /var/www/embodied-pulse

# 安装依赖
cd backend && npm install --production
cd ../frontend && npm install --production
```

#### 3.1.2 配置环境变量

```bash
# 后端配置
cat > /var/www/embodied-pulse/backend/.env << EOF
NODE_ENV=production
PORT=3001

# Database
DATABASE_URL="postgresql://embodied:your_secure_password@localhost:5432/embodied_pulse"

# JWT
JWT_SECRET=your-production-jwt-secret-key-min-32-chars
JWT_REFRESH_SECRET=your-production-refresh-secret-key-min-32-chars
JWT_EXPIRES_IN=7d
REFRESH_TOKEN_EXPIRES_IN=30d

# CORS
CORS_ORIGINS=https://embodiedpulse.com,https://www.embodiedpulse.com

# Redis
REDIS_URL=redis://localhost:6379

# Rate Limit
RATE_LIMIT_MAX=1000
RATE_LIMIT_WINDOW_MS=60000

# Log
LOG_LEVEL=info

# Base URL
BASE_URL=https://api.embodiedpulse.com
EOF

# 前端配置
cat > /var/www/embodied-pulse/frontend/.env.local << EOF
NEXT_PUBLIC_API_URL=https://api.embodiedpulse.com
NEXT_PUBLIC_BASE_URL=https://embodiedpulse.com
EOF
```

#### 3.1.3 数据库初始化

```bash
cd /var/www/embodied-pulse/backend
npx prisma migrate deploy
npm run db:seed
```

#### 3.1.4 构建前端

```bash
cd /var/www/embodied-pulse/frontend
npm run build
```

#### 3.1.5 启动服务

```bash
# 使用PM2启动后端
cd /var/www/embodied-pulse/backend
pm2 start npm --name "embodied-api" -- run start

# 使用PM2启动前端
cd /var/www/embodied-pulse/frontend
pm2 start npm --name "embodied-web" -- run start

# 保存PM2配置
pm2 save
pm2 startup
```

### 3.2 方式二：Docker 部署

#### 3.2.1 创建 Dockerfile（后端）

```dockerfile
# backend/Dockerfile
FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY prisma ./prisma/
RUN npx prisma generate

COPY dist ./dist/

EXPOSE 3001

CMD ["node", "dist/index.js"]
```

#### 3.2.2 创建 Dockerfile（前端）

```dockerfile
# frontend/Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM node:20-alpine AS runner

WORKDIR /app

COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public ./public

EXPOSE 3000

CMD ["node", "server.js"]
```

#### 3.2.3 Docker Compose 配置

```yaml
# docker-compose.yml
version: '3.8'

services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://api.embodiedpulse.com
    depends_on:
      - backend

  backend:
    build: ./backend
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://embodied:password@postgres:5432/embodied_pulse
      - JWT_SECRET=your-jwt-secret
      - JWT_REFRESH_SECRET=your-refresh-secret
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=embodied
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=embodied_pulse
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

#### 3.2.4 启动 Docker 服务

```bash
# 构建并启动
docker-compose up -d --build

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 3.3 方式三：开发环境部署

```bash
# 进入项目目录
cd "/Users/dong/Downloads/WaleHouse/01-Finance/打工-LimX（202503-至今）/Embodied Pulse"

# 启动后端（终端1）
cd backend
npm install
npm run dev

# 启动前端（终端2）
cd frontend
npm install
npm run dev
```

---

## 4. 配置说明

### 4.1 环境变量清单

#### 后端环境变量

| 变量名 | 必填 | 开发环境默认值 | 生产环境 |
|--------|------|----------------|----------|
| NODE_ENV | 是 | development | production |
| PORT | 是 | 3001 | 3001 |
| DATABASE_URL | 是 | file:./prisma/dev-user.db | postgresql://... |
| JWT_SECRET | 是 | dev-jwt-secret-... | 强密钥 (32+字符) |
| JWT_REFRESH_SECRET | 是 | dev-refresh-secret-... | 强密钥 (32+字符) |
| JWT_EXPIRES_IN | 否 | 7d | 7d |
| REFRESH_TOKEN_EXPIRES_IN | 否 | 30d | 30d |
| CORS_ORIGINS | 是 | http://localhost:3000 | 生产域名 |
| REDIS_URL | 否 | redis://localhost:6379 | redis://... |
| RATE_LIMIT_MAX | 否 | 1000 | 1000 |
| RATE_LIMIT_WINDOW_MS | 否 | 60000 | 60000 |
| LOG_LEVEL | 否 | debug | info |
| BASE_URL | 是 | http://localhost:3001 | https://api... |

#### 前端环境变量

| 变量名 | 必填 | 说明 |
|--------|------|------|
| NEXT_PUBLIC_API_URL | 是 | 后端API地址 |
| NEXT_PUBLIC_BASE_URL | 否 | 前端基础URL |
| NEXT_PUBLIC_WS_URL | 否 | WebSocket地址 |

### 4.2 端口配置

| 服务 | 默认端口 | 说明 |
|------|----------|------|
| 前端 | 3000 | Next.js服务 |
| 后端 | 3001 | Express API |
| PostgreSQL | 5432 | 数据库 |
| Redis | 6379 | 缓存/队列 |

### 4.3 Nginx 配置

```nginx
# /etc/nginx/sites-available/embodied-pulse.conf

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name embodiedpulse.com www.embodiedpulse.com api.embodiedpulse.com;
    return 301 https://$server_name$request_uri;
}

# 前端服务
server {
    listen 443 ssl http2;
    server_name embodiedpulse.com www.embodiedpulse.com;

    ssl_certificate /etc/letsencrypt/live/embodiedpulse.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/embodiedpulse.com/privkey.pem;

    # SSL 配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# 后端API服务
server {
    listen 443 ssl http2;
    server_name api.embodiedpulse.com;

    ssl_certificate /etc/letsencrypt/live/embodiedpulse.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/embodiedpulse.com/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

```bash
# 启用配置
sudo ln -s /etc/nginx/sites-available/embodied-pulse.conf /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 4.4 SSL 证书配置

```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d embodiedpulse.com -d www.embodiedpulse.com -d api.embodiedpulse.com

# 自动续期
sudo certbot renew --dry-run
```

---

## 5. 监控与维护

### 5.1 日志管理

```bash
# 查看PM2日志
pm2 logs
pm2 logs embodied-api
pm2 logs embodied-web

# 查看Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# 查看系统日志
journalctl -u nginx -f
journalctl -u postgresql -f
journalctl -u redis-server -f
```

### 5.2 服务管理

```bash
# 查看服务状态
pm2 status

# 重启服务
pm2 restart all
pm2 restart embodied-api
pm2 restart embodied-web

# 停止服务
pm2 stop all

# 监控面板
pm2 monit

# 查看详细信息
pm2 describe embodied-api
```

### 5.3 健康检查

```bash
# 检查前端
curl -I https://embodiedpulse.com

# 检查后端API
curl https://api.embodiedpulse.com/api/v1/health

# 检查数据库
psql -U embodied -d embodied_pulse -c "SELECT 1"

# 检查Redis
redis-cli ping
```

### 5.4 数据备份

```bash
# 创建备份脚本
cat > /var/www/embodied-pulse/scripts/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/var/backups/embodied-pulse"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 数据库备份
pg_dump -U embodied embodied_pulse > $BACKUP_DIR/db_$DATE.sql

# 压缩备份
gzip $BACKUP_DIR/db_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "Backup completed: db_$DATE.sql.gz"
EOF

chmod +x /var/www/embodied-pulse/scripts/backup.sh

# 添加到crontab（每天凌晨2点备份）
(crontab -l 2>/dev/null; echo "0 2 * * * /var/www/embodied-pulse/scripts/backup.sh >> /var/log/embodied-backup.log 2>&1") | crontab -
```

### 5.5 监控告警

推荐使用 PM2 Plus 或其他监控服务：

```bash
# PM2 Plus
pm2 link <secret_key> <public_key>
```

---

## 6. 故障排查

### 6.1 服务无法启动

```bash
# 检查端口占用
netstat -tlnp | grep 3000
netstat -tlnp | grep 3001

# 检查进程
ps aux | grep node

# 检查日志
pm2 logs --lines 100

# 检查环境变量
pm2 env 0
```

### 6.2 数据库连接失败

```bash
# 检查PostgreSQL状态
sudo systemctl status postgresql

# 测试连接
psql -U embodied -d embodied_pulse -h localhost

# 检查连接数
psql -U embodied -d embodied_pulse -c "SELECT count(*) FROM pg_stat_activity;"

# 查看错误日志
tail -f /var/log/postgresql/postgresql-15-main.log
```

### 6.3 Redis连接失败

```bash
# 检查Redis状态
sudo systemctl status redis-server

# 测试连接
redis-cli ping

# 查看Redis信息
redis-cli info

# 查看内存使用
redis-cli info memory
```

### 6.4 前端页面空白

```bash
# 检查构建产物
ls -la /var/www/embodied-pulse/frontend/.next

# 检查环境变量
cat /var/www/embodied-pulse/frontend/.env.local

# 重新构建
cd /var/www/embodied-pulse/frontend
npm run build
pm2 restart embodied-web
```

### 6.5 API 请求失败

```bash
# 检查后端日志
pm2 logs embodied-api --lines 100

# 检查CORS配置
curl -I -X OPTIONS https://api.embodiedpulse.com/api/v1/papers \
  -H "Origin: https://embodiedpulse.com" \
  -H "Access-Control-Request-Method: GET"

# 检查JWT配置
# 确保JWT_SECRET和JWT_REFRESH_SECRET已正确设置
```

### 6.6 SSL证书问题

```bash
# 检查证书状态
sudo certbot certificates

# 手动续期
sudo certbot renew

# 测试续期
sudo certbot renew --dry-run

# 检查Nginx配置
sudo nginx -t
```

---

## 7. 更新与回滚

### 7.1 更新部署

```bash
# 1. 备份当前版本
cd /var/www/embodied-pulse
tar -czf ../embodied-pulse-backup-$(date +%Y%m%d).tar.gz .

# 2. 拉取最新代码
git pull origin main

# 3. 更新后端依赖
cd backend
npm install --production

# 4. 数据库迁移
npx prisma migrate deploy

# 5. 更新前端依赖
cd ../frontend
npm install --production

# 6. 重新构建前端
npm run build

# 7. 重启服务
pm2 restart all
```

### 7.2 回滚操作

```bash
# 1. 停止服务
pm2 stop all

# 2. 恢复代码
cd /var/www
rm -rf embodied-pulse
tar -xzf embodied-pulse-backup-YYYYMMDD.tar.gz -C embodied-pulse

# 3. 恢复数据库（如需要）
gunzip -c /var/backups/embodied-pulse/db_YYYYMMDD.sql.gz | psql -U embodied embodied_pulse

# 4. 重启服务
pm2 start all
```

### 7.3 蓝绿部署（推荐）

```bash
# 1. 部署新版本到不同目录
git clone <repository-url> /var/www/embodied-pulse-new
cd /var/www/embodied-pulse-new
# ... 执行部署步骤 ...

# 2. 切换Nginx配置指向新版本
# 修改 upstream 配置

# 3. 重载Nginx
sudo nginx -s reload

# 4. 验证新版本正常后，删除旧版本
rm -rf /var/www/embodied-pulse-old
```

---

## 附录

### A. 开发环境快速启动

```bash
# 项目路径
cd "/Users/dong/Downloads/WaleHouse/01-Finance/打工-LimX（202503-至今）/Embodied Pulse"

# 启动后端
cd backend && npm run dev

# 启动前端（新终端）
cd frontend && npm run dev

# 访问地址
# 前端: http://localhost:3000
# 后端: http://localhost:3001
```

### B. 常用命令速查

| 操作 | 命令 |
|------|------|
| 查看服务状态 | `pm2 status` |
| 重启所有服务 | `pm2 restart all` |
| 查看日志 | `pm2 logs` |
| 查看数据库 | `npx prisma studio` |
| 数据库迁移 | `npx prisma migrate deploy` |
| 生成Prisma客户端 | `npx prisma generate` |
| 检查Nginx配置 | `sudo nginx -t` |
| 重载Nginx | `sudo systemctl reload nginx` |

### C. 相关文档

| 文档 | 路径 |
|------|------|
| 开发者操作手册 | `docs/03-开发/开发者操作手册.md` |
| 测试文档 | `docs/04-测试/测试文档.md` |
| API接口文档 | `docs/02-设计/API接口文档.md` |

---

**文档维护**：本文档将随部署实践持续更新。

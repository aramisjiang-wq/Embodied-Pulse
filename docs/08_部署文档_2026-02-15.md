# Embodied Pulse 部署文档

**产品名称**：Embodied Pulse（具身智能脉搏）  
**文档类型**：部署指南  
**版本**：v1.0  
**更新日期**：2026-02-15  
**适用对象**：运维人员、开发者  

---

## 目录

1. [部署架构](#1-部署架构)
2. [环境准备](#2-环境准备)
3. [部署步骤](#3-部署步骤)
4. [配置说明](#4-配置说明)
5. [监控与维护](#5-监控与维护)
6. [故障排查](#6-故障排查)

---

## 1. 部署架构

### 1.1 生产环境架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              生产环境架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                  │
│  │   用户请求   │────▶│   Nginx     │────▶│   前端服务   │                  │
│  └─────────────┘     │  反向代理    │     │  Next.js    │                  │
│                      └──────┬──────┘     └─────────────┘                  │
│                             │                                               │
│                             ▼                                               │
│                      ┌─────────────┐                                       │
│                      │   后端服务   │                                       │
│                      │  Express    │                                       │
│                      └──────┬──────┘                                       │
│                             │                                               │
│              ┌──────────────┼──────────────┐                               │
│              ▼              ▼              ▼                               │
│       ┌───────────┐  ┌───────────┐  ┌───────────┐                         │
│       │PostgreSQL │  │   Redis   │  │ 文件存储   │                         │
│       │  主数据库  │  │   缓存    │  │  (OSS)    │                         │
│       └───────────┘  └───────────┘  └───────────┘                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 服务器要求

| 组件 | 最低配置 | 推荐配置 |
|------|----------|----------|
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 存储 | 50GB SSD | 100GB+ SSD |
| 带宽 | 5Mbps | 10Mbps+ |

---

## 2. 环境准备

### 2.1 安装依赖

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Node.js 20.x
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# 安装PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# 安装Redis
sudo apt install -y redis-server

# 安装Nginx
sudo apt install -y nginx

# 安装PM2
sudo npm install -g pm2
```

### 2.2 数据库配置

```bash
# 创建数据库用户
sudo -u postgres psql
CREATE USER embodied WITH PASSWORD 'your_password';
CREATE DATABASE embodied OWNER embodied;
GRANT ALL PRIVILEGES ON DATABASE embodied TO embodied;
\q

# 配置Redis
sudo systemctl enable redis-server
sudo systemctl start redis-server
```

---

## 3. 部署步骤

### 3.1 获取代码

```bash
# 克隆项目
git clone <repository-url> /var/www/embodied
cd /var/www/embodied

# 安装依赖
cd backend && npm install --production
cd ../frontend && npm install --production
```

### 3.2 配置环境变量

```bash
# 后端配置
cat > /var/www/embodied/backend/.env << EOF
NODE_ENV=production
DATABASE_URL=postgresql://embodied:your_password@localhost:5432/embodied
JWT_ACCESS_SECRET=your_access_secret_key
JWT_REFRESH_SECRET=your_refresh_secret_key
SMTP_USER=your_email@qq.com
SMTP_PASS=your_smtp_password
REDIS_URL=redis://localhost:6379
EOF

# 前端配置
cat > /var/www/embodied/frontend/.env.local << EOF
NEXT_PUBLIC_API_URL=https://api.yourdomain.com
EOF
```

### 3.3 数据库初始化

```bash
cd /var/www/embodied/backend
npx prisma migrate deploy
npx prisma db seed
```

### 3.4 构建前端

```bash
cd /var/www/embodied/frontend
npm run build
```

### 3.5 启动服务

```bash
# 使用PM2启动后端
cd /var/www/embodied/backend
pm2 start npm --name "embodied-api" -- run start

# 使用PM2启动前端
cd /var/www/embodied/frontend
pm2 start npm --name "embodied-web" -- run start

# 保存PM2配置
pm2 save
pm2 startup
```

### 3.6 配置Nginx

```nginx
# /etc/nginx/sites-available/embodied.conf

server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # 前端
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # 后端API
    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

```bash
# 启用配置
sudo ln -s /etc/nginx/sites-available/embodied.conf /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## 4. 配置说明

### 4.1 环境变量清单

| 变量名 | 必填 | 说明 |
|--------|------|------|
| NODE_ENV | 是 | 环境：production/development |
| DATABASE_URL | 是 | 数据库连接字符串 |
| JWT_ACCESS_SECRET | 是 | Access Token密钥 |
| JWT_REFRESH_SECRET | 是 | Refresh Token密钥 |
| SMTP_USER | 是 | SMTP邮箱地址 |
| SMTP_PASS | 是 | SMTP授权码 |
| REDIS_URL | 是 | Redis连接字符串 |

### 4.2 端口配置

| 服务 | 默认端口 | 说明 |
|------|----------|------|
| 前端 | 3000 | Next.js服务 |
| 后端 | 3001 | Express API |
| PostgreSQL | 5432 | 数据库 |
| Redis | 6379 | 缓存服务 |

---

## 5. 监控与维护

### 5.1 日志管理

```bash
# 查看PM2日志
pm2 logs

# 查看Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### 5.2 服务管理

```bash
# 重启服务
pm2 restart all

# 查看状态
pm2 status

# 监控面板
pm2 monit
```

### 5.3 数据备份

```bash
# 数据库备份脚本
#!/bin/bash
BACKUP_DIR="/var/backups/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)
pg_dump embodied > $BACKUP_DIR/embodied_$DATE.sql

# 添加到crontab（每天凌晨2点备份）
0 2 * * * /var/www/embodied/scripts/backup.sh
```

---

## 6. 故障排查

### 6.1 服务无法启动

```bash
# 检查端口占用
netstat -tlnp | grep 3000
netstat -tlnp | grep 3001

# 检查进程
ps aux | grep node

# 检查日志
pm2 logs --lines 100
```

### 6.2 数据库连接失败

```bash
# 检查PostgreSQL状态
sudo systemctl status postgresql

# 测试连接
psql -U embodied -d embodied -h localhost
```

### 6.3 Redis连接失败

```bash
# 检查Redis状态
sudo systemctl status redis-server

# 测试连接
redis-cli ping
```

### 6.4 SSL证书问题

```bash
# 更新证书
sudo certbot renew

# 检查证书
sudo certbot certificates
```

---

## 更新部署

```bash
# 拉取最新代码
cd /var/www/embodied
git pull origin main

# 更新依赖
cd backend && npm install --production
cd ../frontend && npm install --production

# 数据库迁移
cd backend
npx prisma migrate deploy

# 重新构建
cd ../frontend
npm run build

# 重启服务
pm2 restart all
```

---

**文档维护**：本文档将随部署实践持续更新。

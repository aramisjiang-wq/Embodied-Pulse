# Embodied Pulse 发版记录

**产品名称**：Embodied Pulse（具身智能脉搏）  
**文档类型**：发版记录  
**版本**：v3.1  
**Base URL**：http://localhost:3000（前端）、http://localhost:3001（后端）  
**更新日期**：2026-02-15  
**状态**：已发布  

---

## 版本概览

| 版本 | 发布日期 | 状态 | 主要变更 |
|------|----------|------|----------|
| v3.1.0 | 2026-02-15 | ✅ 已发布 | 认证系统重构、自定义页面功能 |
| v3.0.0 | 2026-02-03 | ✅ 已发布 | 社区功能完善 |
| v2.0.0 | 2026-02-01 | ✅ 已发布 | 数据同步系统 |
| v1.5.0 | 2026-01-28 | ✅ 已发布 | 用户系统上线 |

---

## v3.1.0 发布详情

| 项目 | 详情 |
|------|------|
| **发布日期** | 2026-02-15 |
| **发布类型** | Minor |
| **状态** | 已发布 |

### 主要功能

| 模块 | 功能 | 状态 |
|------|------|------|
| 认证系统 | 邮箱验证码注册 | ✅ |
| 认证系统 | 密码找回功能 | ✅ |
| 认证系统 | 移除 GitHub OAuth | ✅ |
| 内容管理 | 管理员自定义页面 | ✅ |
| 内容管理 | 富文本编辑支持 | ✅ |

### 技术更新

| 变更类型 | 变更内容 |
|----------|----------|
| 新增 | /api/v1/email-verification/send 验证码发送接口 |
| 新增 | /api/v1/email-verification/verify 验证码验证接口 |
| 新增 | /api/v1/password-reset/request 密码重置请求接口 |
| 新增 | /api/v1/password-reset/confirm 密码重置确认接口 |
| 新增 | /api/v1/custom-pages 自定义页面接口 |
| 新增 | nodemailer 邮件服务 |
| 新增 | EmailVerification 数据模型 |
| 新增 | PasswordReset 数据模型 |
| 新增 | CustomPage 数据模型 |
| 移除 | GitHub OAuth 登录功能 |
| 移除 | /api/v1/auth/github 接口 |

### 问题修复

| 问题 ID | 问题描述 | 严重程度 | 状态 |
|---------|----------|----------|------|
| BUG-101 | 点击"我的市集"自动跳转登录页 | P0 | ✅ 已修复 |
| BUG-102 | 登录后闪退 | P0 | ✅ 已修复 |
| BUG-103 | GitHub OAuth 登录失败 | P1 | ✅ 已移除功能 |
| BUG-104 | 邮箱验证码发送失败 | P0 | ✅ 已修复 |
| BUG-105 | EmailVerification 模型缺失 | P0 | ✅ 已修复 |

### 修复详情

#### BUG-101: 点击"我的市集"自动跳转登录页

| 项目 | 详情 |
|------|------|
| **问题描述** | 已登录用户点击"我的市集"菜单时，自动跳转到登录页面 |
| **根因分析** | /posts/my 接口被错误地归类为公开 API，未携带认证 Token |
| **解决方案** | 在 API 客户端中将 /posts/my 和 /posts/like 从公开 API 列表中排除 |
| **影响文件** | frontend/src/lib/api/client.ts |

#### BUG-102: 登录后闪退

| 项目 | 详情 |
|------|------|
| **问题描述** | 用户登录成功后，页面立即退出登录状态 |
| **根因分析** | /api/v1/notifications/unread-count 接口返回 500 错误，导致前端认证状态异常 |
| **解决方案** | 修复 notification.service.ts 中的字段名不匹配问题（camelCase → snake_case） |
| **影响文件** | backend/src/services/notification.service.ts |

#### BUG-103: GitHub OAuth 登录失败

| 项目 | 详情 |
|------|------|
| **问题描述** | GitHub OAuth 登录返回 401 错误 |
| **根因分析** | 网络环境限制，无法稳定访问 GitHub API |
| **解决方案** | 移除 GitHub OAuth 功能，改用邮箱+密码登录 |
| **影响文件** | auth.controller.ts, auth.routes.ts, client.ts, login/page.tsx |

#### BUG-104: 邮箱验证码发送失败

| 项目 | 详情 |
|------|------|
| **问题描述** | 调用验证码发送接口返回 500 错误 |
| **根因分析** | EmailVerification 和 PasswordReset 模型未添加到用户数据库 schema |
| **解决方案** | 将模型添加到 schema.user.prisma 并执行数据库同步 |
| **影响文件** | backend/prisma/schema.user.prisma |

---

## 新功能详情

### 1. 邮箱验证码注册

**功能描述**：用户注册时需要通过邮箱验证码验证身份

**流程**：
1. 用户输入邮箱地址
2. 系统发送 6 位验证码到邮箱
3. 用户输入验证码
4. 验证通过后完成注册

**API 接口**：

| 接口 | 方法 | 描述 |
|------|------|------|
| /api/v1/email-verification/send | POST | 发送验证码 |
| /api/v1/email-verification/verify | POST | 验证验证码 |

**配置**：

| 配置项 | 值 | 说明 |
|--------|-----|------|
| 验证码长度 | 6 位 | 数字验证码 |
| 有效期 | 10 分钟 | 过期后需重新获取 |
| SMTP 服务 | QQ 邮箱 | smtp.qq.com:465 |

### 2. 密码找回功能

**功能描述**：用户忘记密码时可通过邮箱重置密码

**流程**：
1. 用户在忘记密码页面输入邮箱
2. 系统发送重置链接到邮箱
3. 用户点击链接跳转到重置页面
4. 用户输入新密码完成重置

**API 接口**：

| 接口 | 方法 | 描述 |
|------|------|------|
| /api/v1/password-reset/request | POST | 请求密码重置 |
| /api/v1/password-reset/confirm | POST | 确认密码重置 |

**配置**：

| 配置项 | 值 | 说明 |
|--------|-----|------|
| Token 长度 | 32 位 | 十六进制字符串 |
| 有效期 | 1 小时 | 过期后需重新申请 |

### 3. 管理员自定义页面

**功能描述**：管理员可创建自定义页面，支持富文本编辑

**功能特点**：
- 支持富文本编辑器
- 支持页面排序
- 支持启用/禁用
- 支持自定义 slug

**API 接口**：

| 接口 | 方法 | 描述 |
|------|------|------|
| /api/v1/custom-pages | GET | 获取页面列表 |
| /api/v1/custom-pages | POST | 创建页面 |
| /api/v1/custom-pages/:id | PUT | 更新页面 |
| /api/v1/custom-pages/:id | DELETE | 删除页面 |
| /api/v1/custom-pages/slug/:slug | GET | 根据 slug 获取页面 |

**前端页面**：
- 管理端：/admin/pages - 页面管理
- 用户端：/page/[slug] - 页面展示

---

## 数据库变更

### 新增表

#### email_verifications

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 主键 |
| email | String | 邮箱地址 |
| code | String | 验证码 |
| type | String | 类型（register/reset） |
| expires_at | DateTime | 过期时间 |
| used | Boolean | 是否已使用 |
| created_at | DateTime | 创建时间 |

#### password_resets

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 主键 |
| email | String | 邮箱地址 |
| token | String | 重置令牌 |
| expires_at | DateTime | 过期时间 |
| used | Boolean | 是否已使用 |
| created_at | DateTime | 创建时间 |

#### custom_pages

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 主键 |
| title | String | 页面标题 |
| slug | String | URL 标识 |
| content | String | 页面内容（HTML） |
| is_active | Boolean | 是否启用 |
| sort_order | Int | 排序 |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

---

## 安全更新

| 更新项 | 说明 |
|--------|------|
| 移除 GitHub OAuth | 消除第三方登录风险 |
| 邮箱验证 | 确保注册用户邮箱真实有效 |
| 密码重置 | 安全的密码找回机制 |
| Token 过期 | 验证码和重置链接均有有效期限制 |

---

## 测试报告

### API 测试结果

| 测试用例 | 接口 | 结果 |
|----------|------|------|
| 发送邮箱验证码 | POST /api/v1/email-verification/send | ✅ 通过 |
| 用户登录（错误密码） | POST /api/v1/auth/login | ✅ 通过 |
| 管理员登录 | POST /api/v1/auth/admin/login | ✅ 通过 |
| 密码重置请求 | POST /api/v1/password-reset/request | ✅ 通过 |
| 邮箱已注册检测 | POST /api/v1/email-verification/send | ✅ 通过 |

### 测试通过率

| 项目 | 结果 |
|------|------|
| **测试通过率** | 100% (5/5) |
| **代码清理** | GitHub OAuth 代码已完全移除 |
| **数据库** | 模型已同步，表已创建 |
| **邮件服务** | QQ邮箱 SMTP 正常工作 |

---

## 升级指南

### 从 v3.0.0 升级到 v3.1.0

1. **更新代码**
   ```bash
   git pull origin main
   ```

2. **更新依赖**
   ```bash
   cd backend && npm install
   cd frontend && npm install
   ```

3. **同步数据库**
   ```bash
   cd backend
   npx prisma db push --schema=prisma/schema.user.prisma
   ```

4. **配置环境变量**
   
   添加以下环境变量到 `.env`：
   ```
   SMTP_USER=your_email@qq.com
   SMTP_PASS=your_authorization_code
   ```

5. **重启服务**
   ```bash
   # 后端
   cd backend && npm run dev
   
   # 前端
   cd frontend && npm run dev
   ```

---

## 已知问题

| 问题 | 严重程度 | 状态 | 计划修复 |
|------|----------|------|----------|
| JWT Secret 弱密码 | 中 | 待修复 | v3.2.0 |
| SMTP 凭据硬编码 | 低 | 待修复 | v3.2.0 |
| 验证码发送频率限制 | 低 | 待实现 | v3.2.0 |

---

## 下一步计划

### v3.2.0 计划功能

| 功能 | 优先级 | 状态 |
|------|--------|------|
| 登录失败次数限制 | P0 | 计划中 |
| 验证码发送频率限制 | P1 | 计划中 |
| JWT Secret 配置化 | P1 | 计划中 |
| 操作日志记录 | P2 | 计划中 |
| API 文档完善 | P2 | 计划中 |

---

**文档编写**：AI Assistant  
**审核状态**：已发布  
**最后更新**：2026-02-15

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®¤è¯æµ‹è¯•é¡µé¢</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #1890ff; }
    h2 { color: #333; margin-top: 0; }
    button {
      background: #1890ff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover { background: #40a9ff; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .success { color: #52c41a; }
    .error { color: #ff4d4f; }
    .warning { color: #faad14; }
    pre {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    .log-entry { margin-bottom: 5px; }
    .log-time { color: #6a9955; }
    .log-info { color: #9cdcfe; }
    .log-success { color: #4ec9b0; }
    .log-error { color: #f14c4c; }
    .log-warn { color: #cca700; }
  </style>
</head>
<body>
  <h1>ğŸ” è®¤è¯æµ‹è¯•é¡µé¢</h1>
  
  <div class="card">
    <h2>1. localStorage çŠ¶æ€</h2>
    <button onclick="checkLocalStorage()">æ£€æŸ¥ localStorage</button>
    <button onclick="clearLocalStorage()">æ¸…ç©º localStorage</button>
    <pre id="localStorageStatus">ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹...</pre>
  </div>

  <div class="card">
    <h2>2. ç™»å½•æµ‹è¯•</h2>
    <button onclick="testLogin()">æµ‹è¯•ç™»å½• API</button>
    <button onclick="simulateFrontendLogin()">æ¨¡æ‹Ÿå‰ç«¯ç™»å½•æµç¨‹</button>
    <pre id="loginResult">ç‚¹å‡»æŒ‰é’®æµ‹è¯•...</pre>
  </div>

  <div class="card">
    <h2>3. Token éªŒè¯</h2>
    <button onclick="testToken()">éªŒè¯å½“å‰ Token</button>
    <button onclick="testFavorites()">æµ‹è¯• /favorites API</button>
    <pre id="tokenResult">ç‚¹å‡»æŒ‰é’®æµ‹è¯•...</pre>
  </div>

  <div class="card">
    <h2>4. å®Œæ•´æ—¥å¿—</h2>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    <div id="log" class="log"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001/api/v1';
    
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[${type.toUpperCase()}]`, message);
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    function checkLocalStorage() {
      const status = document.getElementById('localStorageStatus');
      const userToken = localStorage.getItem('user_token');
      const adminToken = localStorage.getItem('admin_token');
      const userUser = localStorage.getItem('user_user');
      const adminUser = localStorage.getItem('admin_user');
      
      log('æ£€æŸ¥ localStorage...', 'info');
      
      status.innerHTML = `
user_token: ${userToken ? userToken.substring(0, 50) + '...' : 'null'}
admin_token: ${adminToken ? adminToken.substring(0, 50) + '...' : 'null'}
user_user: ${userUser || 'null'}
admin_user: ${adminUser || 'null'}
      `.trim();
      
      if (userToken) {
        log('âœ… å‘ç° user_token', 'success');
      } else {
        log('âš ï¸ æœªæ‰¾åˆ° user_token', 'warn');
      }
    }

    function clearLocalStorage() {
      localStorage.removeItem('user_token');
      localStorage.removeItem('admin_token');
      localStorage.removeItem('user_user');
      localStorage.removeItem('admin_user');
      log('å·²æ¸…ç©º localStorage', 'warn');
      checkLocalStorage();
    }

    async function testLogin() {
      const resultDiv = document.getElementById('loginResult');
      resultDiv.textContent = 'ç™»å½•ä¸­...';
      log('å¼€å§‹ç™»å½•æµ‹è¯•...', 'info');
      
      try {
        const response = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: 'test@test.com', password: 'Test123456' })
        });
        
        const data = await response.json();
        
        if (response.ok && data.data?.token) {
          log('âœ… ç™»å½•æˆåŠŸï¼', 'success');
          log(`Token: ${data.data.token.substring(0, 30)}...`, 'info');
          log(`User: ${JSON.stringify(data.data.user)}`, 'info');
          
          // ä¿å­˜åˆ° localStorage
          localStorage.setItem('user_token', data.data.token);
          localStorage.setItem('user_user', JSON.stringify(data.data.user));
          log('âœ… å·²ä¿å­˜åˆ° localStorage', 'success');
          
          resultDiv.innerHTML = `<span class="success">ç™»å½•æˆåŠŸï¼</span>
Token: ${data.data.token.substring(0, 50)}...
User: ${JSON.stringify(data.data.user, null, 2)}`;
          
          checkLocalStorage();
        } else {
          log('âŒ ç™»å½•å¤±è´¥: ' + JSON.stringify(data), 'error');
          resultDiv.innerHTML = `<span class="error">ç™»å½•å¤±è´¥</span>
${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        log('âŒ è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
        resultDiv.innerHTML = `<span class="error">è¯·æ±‚å¤±è´¥</span>
${error.message}`;
      }
    }

    async function simulateFrontendLogin() {
      log('æ¨¡æ‹Ÿå‰ç«¯ç™»å½•æµç¨‹...', 'info');
      
      // 1. å…ˆæ¸…ç©º
      localStorage.removeItem('user_token');
      localStorage.removeItem('user_user');
      log('å·²æ¸…ç©ºæ—§ token', 'info');
      
      // 2. ç™»å½•
      const response = await fetch(`${API_BASE}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: 'test@test.com', password: 'Test123456' })
      });
      
      const data = await response.json();
      
      if (!response.ok || !data.data?.token) {
        log('âŒ ç™»å½•å¤±è´¥', 'error');
        return;
      }
      
      const { token, user } = data.data;
      log(`ç™»å½•æˆåŠŸï¼Œtoken: ${token.substring(0, 30)}...`, 'success');
      
      // 3. æ¨¡æ‹Ÿ authStore.setToken çš„é€»è¾‘
      const key = 'user_token';
      const userKey = 'user_user';
      
      localStorage.setItem(key, token);
      log(`å·²ä¿å­˜ token åˆ° ${key}`, 'success');
      
      localStorage.setItem(userKey, JSON.stringify(user));
      log(`å·²ä¿å­˜ user åˆ° ${userKey}`, 'success');
      
      // 4. ç«‹å³éªŒè¯
      const savedToken = localStorage.getItem('user_token');
      const savedUser = localStorage.getItem('user_user');
      
      log(`éªŒè¯: savedToken = ${savedToken?.substring(0, 30)}...`, 'info');
      log(`éªŒè¯: savedUser = ${savedUser}`, 'info');
      
      // 5. æ¨¡æ‹Ÿé¡µé¢è·³è½¬
      log('æ¨¡æ‹Ÿé¡µé¢è·³è½¬ (300ms å)...', 'info');
      
      await new Promise(resolve => setTimeout(resolve, 300));
      
      // 6. è·³è½¬åå†æ¬¡éªŒè¯
      const afterToken = localStorage.getItem('user_token');
      const afterUser = localStorage.getItem('user_user');
      
      log(`è·³è½¬åéªŒè¯: token = ${afterToken?.substring(0, 30)}...`, 'info');
      log(`è·³è½¬åéªŒè¯: user = ${afterUser}`, 'info');
      
      if (afterToken === token) {
        log('âœ… Token åœ¨è·³è½¬åä»ç„¶å­˜åœ¨ï¼', 'success');
      } else {
        log('âŒ Token åœ¨è·³è½¬åä¸¢å¤±ï¼', 'error');
      }
      
      checkLocalStorage();
    }

    async function testToken() {
      const token = localStorage.getItem('user_token');
      const resultDiv = document.getElementById('tokenResult');
      
      if (!token) {
        log('âŒ æœªæ‰¾åˆ° tokenï¼Œè¯·å…ˆç™»å½•', 'error');
        resultDiv.innerHTML = '<span class="error">æœªæ‰¾åˆ° tokenï¼Œè¯·å…ˆç™»å½•</span>';
        return;
      }
      
      log('éªŒè¯ token...', 'info');
      
      try {
        const response = await fetch(`${API_BASE}/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          log('âœ… Token æœ‰æ•ˆï¼', 'success');
          resultDiv.innerHTML = `<span class="success">Token æœ‰æ•ˆ</span>
${JSON.stringify(data, null, 2)}`;
        } else {
          log('âŒ Token æ— æ•ˆ: ' + JSON.stringify(data), 'error');
          resultDiv.innerHTML = `<span class="error">Token æ— æ•ˆ</span>
${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        log('âŒ è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
        resultDiv.innerHTML = `<span class="error">è¯·æ±‚å¤±è´¥</span>
${error.message}`;
      }
    }

    async function testFavorites() {
      const token = localStorage.getItem('user_token');
      const resultDiv = document.getElementById('tokenResult');
      
      if (!token) {
        log('âŒ æœªæ‰¾åˆ° tokenï¼Œè¯·å…ˆç™»å½•', 'error');
        resultDiv.innerHTML = '<span class="error">æœªæ‰¾åˆ° tokenï¼Œè¯·å…ˆç™»å½•</span>';
        return;
      }
      
      log('æµ‹è¯• /favorites API...', 'info');
      
      try {
        const response = await fetch(`${API_BASE}/favorites?page=1&size=10`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        
        if (response.status === 401) {
          log('âŒ 401 æœªæˆæƒï¼Token å¯èƒ½æ— æ•ˆæˆ–è¯·æ±‚æœªæºå¸¦ Authorization header', 'error');
          resultDiv.innerHTML = `<span class="error">401 æœªæˆæƒ</span>
${JSON.stringify(data, null, 2)}`;
        } else if (response.ok) {
          log('âœ… /favorites API æ­£å¸¸ï¼', 'success');
          resultDiv.innerHTML = `<span class="success">API æ­£å¸¸</span>
${JSON.stringify(data, null, 2)}`;
        } else {
          log('âš ï¸ API è¿”å›éé¢„æœŸçŠ¶æ€: ' + response.status, 'warn');
          resultDiv.innerHTML = `<span class="warning">çŠ¶æ€ ${response.status}</span>
${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        log('âŒ è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
        resultDiv.innerHTML = `<span class="error">è¯·æ±‚å¤±è´¥</span>
${error.message}`;
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.onload = () => {
      log('é¡µé¢åŠ è½½å®Œæˆ', 'info');
      checkLocalStorage();
    };
  </script>
</body>
</html>
